Magnetic resonance imaging-guided attenuation correction in whole-body PET/MRI using a sorted atlas approach Hossein Arabi1 and Habib Zaidi1,2,3 1Division of Nuclear Medicine and Molecular Imaging, Department of Medical Imaging, Geneva University Hospital, CH-1211 Geneva 4, Switzerland 2Geneva Neuroscience Center, Geneva University, CH-1205 Geneva, Switzerland 3Department of Nuclear Medicine and Molecular Imaging, University of Groningen, University Medical Center Groningen, 9700 RB Groningen, Netherlands Corresponding Author: Habib Zaidi, Ph.D Geneva University Hospital Division of Nuclear Medicine and Molecular Imaging CH-1211 Geneva, Switzerland Tel: +41 22 372 7258 Fax: +41 22 372 7169 email: habib.zaidi@hcuge.ch Running title: Atlas-guided attenuation correction in PET/MRI Â© 2016. This manuscript version is made available under the Elsevier user licensehttp://www.elsevier.com/open-access/userlicense/1.0/1     Abstract Quantitative whole-body PET/MR imaging is challenged by the lack of accurate and robust strategies for attenuation correction. In this work, a new pseudo-CT generation approach, referred to as sorted atlas pseudo-CT (SAP), is proposed for accurate extraction of bones and estimation of lung attenuation properties. This approach improves the Gaussian process regression (GPR) kernel proposed by Hofmann et al. which relies on the information provided by a co-registered atlas (CT and MRI) using a GPR kernel to predict the distribution of attenuation coefficients. Our approach uses two separate GPR kernels for lung and non-lung tissues. For non-lung tissues, the co-registered atlas dataset was sorted on the basis of local normalized cross-correlation similarity to the target MR image to select the most similar image in the atlas for each voxel. For lung tissue, the lung volume was incorporated in the GPR kernel taking advantage of the correlation between lung volume and corresponding attenuation properties to predict the attenuation coefficients of the lung. In the presence of pathological tissues in the lungs, the lesions are segmented on PET images corrected for attenuation using MRI-derived 3-class attenuation map followed by assignment of soft-tissue attenuation coefficient. The proposed algorithm was compared to other techniques reported in the literature including Hofmannâ€™s approach and the 3-class attenuation correction technique implemented on the Philips Ingenuity TF PET/MR where CT-based attenuation correction served as reference. Fourteen patients with head and neck cancer undergoing PET/CT and PET/MR examinations were used for quantitative analysis. SUV measurements were performed on 12 normal uptake regions as well as high uptake malignant regions. Moreover, a number of similarity measures were used to evaluate the accuracy of extracted bones. The Dice similarity metric revealed that the extracted bone improved from 0.58Â±0.09 to 0.65Â±0.07 when using the SAP technique compared to Hofmannâ€™s approach. This enabled to reduce the SUVmean bias in bony structures for the SAP approach to -1.7Â±4.8% as compared to -7.3Â±6.0% and -27.4Â±10.1% when using Hofmannâ€™s approach and the 3-class attenuation map, respectively. Likewise, the 3-class attenuation map produces a relative absolute error of 21.7Â±11.8% in the lungs. This was reduced on average to 15.8Â±8.6% and 8.0Â±3.8% when using Hofmannâ€™s and SAP techniques, respectively. The SAP technique resulted in better overall PET quantification accuracy than both Hofmannâ€™s and the 3-class approaches owing to the more accurate extraction of bones and better prediction of lung attenuation coefficients. Further improvement of the technique and reduction of the computational time are still required. Keywords: PET/MRI, attenuation correction, Pseudo-CT generation, atlas, quantification, SUV. 2   1. Introduction There is growing research and clinical interest in hybrid PET/MRI technology owing to its potential to provide a major breakthrough in diagnostic imaging and clinical practice (Disselhorst et al., 2014). The rationale behind the combination of PET and MRI is the higher soft-tissue contrast of MR images compared to CT, the possibility of using various MRI sequences enabling multiparametric imaging and above all the absence of radiation exposure, a critical issue particularly in serial follow-up studies and paediatric imaging (Torigian et al., 2013; Zaidi and Del Guerra, 2011). Accurate quantification of tracer uptake requires correction for attenuation of annihilation photons, which is not straightforward on current PET/MRI systems that are not equipped with x-ray CT or transmission sources (Bezrukov et al., 2013a; Zaidi and Hasegawa, 2003). Owing to the lack of a direct correspondence between MRI intensities and electron densities, alternative methods are sought for MRI-guided attenuation correction in PET/MRI. The strategies proposed for attenuation correction in PET/MRI can be classified into three major categories: tissue segmentation (Martinez-Moller et al., 2009; Schulz et al., 2011; Zaidi et al., 2003), template or atlas-based machine learning approaches (Burgos et al., 2014; Hofmann et al., 2011; Hofmann et al., 2008; Izquierdo-Garcia et al., 2014; Johansson et al., 2011), and joint estimation of emission and attenuation (Defrise et al., 2012; Mehranian and Zaidi, 2015c). Early attempts to estimate the attenuation map from non-time of flight (TOF) emission data (Panin et al., 2004) achieved limited success. The advent of TOF PET technology introduced new opportunities for accurate derivation of attenuation information from emission data. TOF enables to measure the detection time differences of the coincident annihilation photons with a temporal uncertainty governed by the timing resolution of the PET detectors, which narrows the solution space of PET reconstruction. Tissue segmentation methods rely on segmenting an MR image into a number of tissue classes followed by assignment of uniform linear attenuation coefficients. Atlas-based methods utilize target specific deformed datasets or an anatomical model to consider bones and produce a continuous attenuation map. In addition, machine learning approaches take advantage of the machine learning task of inferring a function from labelled training data consisting of a set of training examples containing voxel-by-voxel correspondence between MR and CT images to predict a continuous attenuation map. Owing to the difficulties associated with bone segmentation, MRI segmentation into 3-classes on the Philips Ingenuity TF PET/MR (background air, lung and soft-tissue) (Schulz et al., 2011; Zaidi et al., 2011) or 4/5-classes on the Siemens mMR PET/MR (background air, lung, fat, mixture of fat and water, and water) (Bezrukov et al., 2013b; Martinez-Moller et al., 2009) are the most widely used strategies on commercial PET/MR systems. Although segmentation-based attenuation correction is deemed to provide satisfactory results in whole-body PET/MR, ignoring bone has noticeable impact on the quantification of tracer uptake in the vicinity of bony structures (Bezrukov et al., 2013b; Hofmann et al., 2011; Schramm et al., 2013; Varoquaux et al., 2014). Recently, a template-based 3 attenuation correction technique which accounts for the presence of the skull in PET brain imaging was introduced on the SIGNA PET/MRI scanner (GE Healthcare, Waukesha, WI) (Wollenweber et al., 2013). The use of ultrashort echo time (UTE) (Keereman et al., 2010) or zero time echo (ZTE) (Delso et al., 2015) sequences to distinguish between bony structures and air proved to be capable of addressing this challenge; however, its applications are currently limited to brain imaging owing to the long acquisition time. Alternatively, it was suggested that the use of a deformed atlas along with patient-specific MR images can overcome this limitation (Burgos et al., 2014; Hofmann et al., 2011; Hofmann et al., 2008), particularly for whole-body imaging where long MR sequences are not feasible yet. Hofmann et al. proposed a novel approach to merge the information obtained from patient-specific MR images and prior knowledge provided by an existing co-registered atlas dataset for the purpose of pseudo-CT generation (Hofmann et al., 2011). In this approach, a Gaussian process regression (GPR) (Ebden, 2008) is utilized to predict the pseudo-CT value for each voxel using intensity information of small patches defined on MR images and the corresponding CT numbers on the aligned atlas dataset. The performance of Hofmannâ€™s approach in terms of deriving bony structures depends highly on the accuracy of the registration with the atlas dataset. To increase the robustness of atlas-based methods to miss-registration errors, Burgos et al. developed synthetic CTs through a multi-atlas information propagation scheme where the MRI-derived patientâ€™s morphology is locally matched to the aligned MRI-CT pairs using a robust local image similarity measure based on local normalized cross-correlation (LNCC) criterion (Burgos et al., 2014). The local matching through morphological similarity enables the algorithm to find local matches and similar anatomy across the atlas dataset. Therefore, poorly matched atlases are discarded or at least given lower weights, which leads to a more patient-specific pseudo-CT. This method was mainly developed for brain PET/MR imaging and was therefore evaluated for this particular application. One of our objectives in this work is to modify Hofmannâ€™s pseudo-CT generation approach in order to improve the accuracy of bone extraction and reduce potential errors due to the miss-registration typical in whole-body imaging situations. The bottleneck of atlas-based segmentation and attenuation correction in whole-body PET/MRI is the level of accuracy achieved by the registration procedure for inter-subject image alignment. Regardless of the type of algorithm, the validation of image registration algorithms depends on the geometry of both target and source images. Introducing a thorough concept that guarantees the accuracy of the registration procedure in non-rigid organs proved to be a difficult task (Murphy et al., 2011). In this work, we relied on a registration procedure validated in a previous work by our group (Akbarzadeh et al., 2013) using the elastix software (Klein et al., 2009). The alignment was performed by combining rigid and non-rigid registration based on normalized mutual information criterion using B-spline interpolator with an adaptive stochastic gradient descent optimizer. 4 Another challenging issue in whole-body PET/MR attenuation correction is the prediction of patient-specific attenuation coefficients for the lung. The density of the lungs might vary between patients owing to respiratory motion (Rosenblum et al., 1980), smoking habits, age or disease state (Soejima et al., 2000). As a consequence, large SUV bias and substantial patient to patient activity recovery variations were reported in the literature (Hofmann et al., 2011). Izquierdo-Garcia et al. reported more than 20% underestimation of SUV in the lung region and noticeable lung density variation from patient to patient (even from left to right lung in the same patient) (Izquierdo-Garcia et al., 2014). To address this issue, Marshall et al. used linear regression to correlate the intensity of the lungs in specific MR sequences (T2 weighted and extrapolated proton density images) and corresponding CT values (Marshall et al., 2012). Berker et al. used maximum likelihood reconstruction of attenuation and activity for the estimation of lung attenuation coefficients from time-of-flight (TOF) PET emission data (Berker et al., 2012). A more stable solution was achieved by exploiting a regularized MLAA algorithm for estimation of lung linear attenuation coefficients using prior knowledge on the Gaussian distribution of lung attenuation coefficients (Mehranian and Zaidi, 2015a). The second major objective of this work is to propose an improved machine learning approach based on GPR for patient-specific prediction of lung attenuation coefficients. The technique incorporates the correlation between lung volume and corresponding density and advantages of morphological similarity between target MRI and atlas datasets. The quantitative assessment of the proposed algorithm was performed using pairs of clinical whole-body PET/MR and PET/CT studies where CT-based attenuation corrected PET images are used as reference. Comparison was also made with Hofmannâ€™s approach as a baseline for evaluation of our method and the 3-class attenuation map technique implemented on the Philips Ingenuity TF PET/MR scanner since segmentation-based methods are commonly used in clinical PET/MR. 2. Materials and Methods 2.1. PET/CT and PET/MRI data acquisition The study population comprised 14 patients, who underwent whole body 18F-FDG PET/MR and whole-body 18F-FDG PET/CT for staging of head and neck malignancies. A single injection of 18F-FDG (371Â±23 MBq) was used to perform whole-body 18F-FDG PET/CT studies at free shallow breathing on a Biograph 64 True Point scanner (Siemens Healthcare, Erlangen, Germany). After a localization scout scan, an unenhanced low dose CT scan (120 kVp, 60 mAs, 24Ã—1.5 collimation) was performed for attenuation correction. The typical acquisition time for whole-body CT scans was less than 10 seconds (axial FOV of 16.2 cm, pitch of 1.2 and 1 s per rotation). PET data acquisition started 5  146.2Â±20 min post-injection with 3 min per bed position for a total of 5-6 beds, resulting in a total acquisition time of 15-18 min. PET/MRI examinations were performed on the Ingenuity TF PET/MR (Philips Healthcare, Cleveland, USA) (Zaidi et al., 2011). The patients were almost in the same position during both examinations with arms down. The so-called atMR whole-body MRI sequence was used for fast (<3 min) derivation of the 3-class attenuation map. It consists of a 3D multi-stack spoiled T1-weighted gradient echo sequence with the following parameters: flip angle 10Â°, TE 2.3 ms, TR 4.1 ms, smallest waterâ€“fat shift, 600 mm transverse FOV with a slab thickness of 120 mm, voxel size 1.9Ã—1.9Ã—6 mm3, 12 mm overlap between adjacent stacks (Schulz et al., 2011). The Philips Ingenuity TF PET/MR utilizes this 3-class attenuation map (air: 0 cm-1, lung: 0.022 cm-1, soft-tissue: 0.098 cm-1) for the purpose of PET attenuation correction (Schulz et al., 2011; Zaidi et al., 2011). The proposed MRI-derived pseudo-CT generation approach uses a whole body MRI Dixon volumetric interpolated T1-weighted sequence (Dixon, 1984) with the following parameters: flip angle 10Â°, TE1 1.1 ms, TE2 2.0 ms, TR 3.2 ms, 450Ã—354 mm2 transverse FOV, 0.85Ã—0.85Ã—3 mm3 voxel size, and a total acquisition time of 2 min 17 s. The study protocol was approved by the institutional ethics committee and all patients gave informed consent. 2.2.  MR data pre-processing The acquired MR images contain a relatively high level of noise, corruption due to the low frequency bias field and inter-patient intensity inhomogeneity (Lotjonen et al., 2010; NyÃºl et al., 2000; Zhuge et al., 2009). As such, the presence of any aforementioned source of intensity uncertainty in MR images might bias the pseudo-CT generation result. To overcome these prospective sources of error, in-phase images of all patients underwent the following pre-processing steps to minimize statistical noise in MR images (gradient anisotropic diffusion filtering), cancel out intra-subject intensity inhomogeneity (N4 bias field correction) and correct inter-subject intensity non-uniformity (histogram matching). Other techniques reported in the literature (Tong et al., 2015) can also be employed for this purpose. ï‚· Gradient anisotropic diffusion filtering (Weickert, 1998) using the following parameters: conductance = 4, number of iterations = 10 and time step = 0.01. This is an edge preserving smoothing algorithm that adjusts the conductance term to produce large diffusion inside regions where the gradient magnitude is relatively small (homogenous regions) and lesser diffusion in regions where the gradient magnitude is large (i.e. edges). ï‚· N4 bias field correction (Tustison et al., 2010): B-spline grid resolution = 400, number of iterations = 200 (at each grid resolution), convergence threshold = 0.001, B-spline order = 3, spline distance = 400, number of histogram bins = 256 and shrink factor = 3. ï‚· Histogram matching (McAuliffe et al., 2001): Histogram level = 512 and match points = 64. In order to get the best result from histogram matching, we excluded background air voxels of both 6 reference and target images before processing. The mean absolute inter-patient MRI intensity variability decreased from 29% to 10% after application of the aforementioned corrections (Robitaille et al., 2012). The proposed pseudo-CT generation procedure entails segmentation of the external body contour as well as lung identification. To this end, the external body contour was determined by applying a 3D snake active contour algorithm on the in-phase MR images (Kass et al., 1988). Identification and segmentation of the lungs was performed through connected-component analysis of the lower intensity in the inner part of the body using the ITK-SNAP image processing software (Yushkevich et al., 2006). The segmentation was performed semi-automatically following initialization by user-specified seeds. Figure 1. (A) Representative slice of in-phase MR Dixon image. (B) Intensity clustered version of the image shown in (A) using K-means Markov random field algorithm in which neighbouring voxels with similar intensity are assigned the same cluster level (1 to 512). (C) In Hofmannâ€™s method, the information extraction from MR images is performed by calculating the weighted average of voxel intensities confined by rectangular sub-volumes (patch). (D) In our SAP approach, the voxel value within the clustered image (dot point) is directly used in the GPR kernel to facilitate the training process and maintain the edge information. In Hofmannâ€™s approach, local information extraction from MRI is performed by calculating the weighted average of intensities confined to rectangular sub-volumes (patches) (Hofmann et al., 2011). These weighted average values are used to assess the local similarity of MRI intensity across subjects as is indicated in figure 1. To alleviate the computational burden involved by computing weighted averages for each patch and more importantly avoid information loss due to the averaging process (particularly at the boundary of organs or in regions with abrupt intensity variations), intensity clustered MR images are utilized in our approach. The clustering process assigns the same cluster 7  label to voxels with similar intensity considering Markov random field regularisation for noise and intensity non-homogeneity reduction. The clustering is carried out using the K-means Markov random field algorithm implemented in the ITK software package (Yoo et al., 2002). A 512 bins clustering with 50 iterations and a tolerance of 0.001 was performed to produce the MRc image (figure 1). Therefore, our approach uses the proximity cluster values (the cluster value to which voxels under study belong to) instead of comparing local information across subjects on the basis of weighed intensity averaging of surrounding voxels (figure 1). This enables to further reduce the noise and intensity non-uniformity across the subjects. 2.3. Pseudo-CT generation approach 2.3.1. Hofmannâ€™s approach Since the proposed pseudo-CT generation approach builds on the technique proposed by Hofmann et al. (Hofmann et al., 2011), a brief description of this method is provided here. A Gaussian process regression is utilized to merge the atlas registration and local patch information in order to predict more accurately the pseudo-CT values for each voxel of interest (Hofmann et al., 2008). To this end, a number of CT/MRI pairs served as atlas after undergoing pairwise non-rigid registration to the target MR image (Eq. 1). In addition to the local information in the co-registered atlas database and intensity similarity of patches, the 5-class segmentation (background air, lung, fat, fat and non-fat mixture and non-fat tissue) of in-phase MR images (Martinez-Moller et al., 2009) and corresponding patch information is used in equation (1). ð‘˜(ð‘‘ð‘–, ð‘‘ð‘—) = exp (âˆ’â€–ð‘Š(ð‘ƒð‘€ð‘…,ð‘–)âˆ’ ð‘Š(ð‘ƒð‘€ð‘…,ð‘—)â€–2ðœŽð‘€ð‘…,ð‘ð‘Žð‘¡ð‘â„Ž22) Ã—  exp (2âˆ’â€–ð‘‹ð‘–âˆ’ ð‘‹ð‘—â€–22ðœŽð‘ð‘œð‘ ) Ã— exp (âˆ’â€–ð‘Š(ð‘ƒð‘†ð‘’ð‘”,ð‘–)âˆ’ ð‘Š(ð‘ƒð‘†ð‘’ð‘”,ð‘—)â€–2ðœŽð‘†ð‘’ð‘”,ð‘ð‘Žð‘¡ð‘â„Ž22)    (1) where d=(PMR, PSeg, X) and PMR and PSeg are sub-volume patches from the in-phase MR image and 5-class segmented MR image, respectively. W is a weighting vector assigning a higher weight to central voxels than peripheral ones in the patch, X is the training center position. Equation (1) represents the kernel of GPR which yields a covariance matrix. The indices i and j refer to the different patches defined on training MR images. In effect, the three terms in the GPR kernel measure the intensity, position and tissue type distance of different patches on training datasets. The parameters Ïƒpos, ÏƒMR,patch and ÏƒSeg,patch determine how the overall kernel value is influenced by similarity in position, patch intensity value in MR and 5-class segmented image. The training is performed on samples of di and dj=(PMR,j , PSeg,j , Xj), i/j=1,2,â€¦,n, drawn from random locations in the MRI atlas database on the basis of known CT values for the corresponding patches. Once the Gaussian regression is trained and the free parameters of Ïƒpos, ÏƒMR,patch and ÏƒSeg,patch determined, equation (2) is used to calculate the pseudo-CT value for each voxel of interest. ð‘ð‘™ = ð‘˜ð‘™ð‘‡ð¶âˆ’1ð‘¦   (2) 8    where cl denotes the calculated pseudo-CT value of a voxel of interest l. kl=k(di,dl) is an (nÃ—1) matrix where di =(PMR,i, PSeg,i, Xi) is the information extracted from the patches defined on the MRI atlas dataset and dl=(PMR,l, PSeg,l, Xl) represents the patch defined on the target MRI. C=k(di,dj) is the (n Ã— n) covariance matrix obtained from equation (1) using di and dj patches defined on MR atlas data set. y stands for a (nÃ—1) vector of CT values corresponding to the central voxel of training patches di. 2.3.2. Proposed sorted atlas pseudo-CT (SAP) approach The proposed pseudo-CT generation approach, referred to as SAP, employs the morphological similarity between the target in-phase MRI and the co-registered atlas database MRIs, which is computed locally using the local normalized cross-correlation (LNCC) metric proposed by Yushkevich et al. (Yushkevich et al., 2010). The LNCC process provides a measure based on which the well-matched atlas images can be selected. The LNCC process is employed to identify the best match or most similar atlas image for each target voxel. Let the MR of the target subject be denoted by Iref and the warped MR images in the atlas database by Im. The LNCC between Iref and Im at voxel v is calculated by: ð¿ð‘ð¶ð¶ð‘£ = âŸ¨ð¼ð‘š,ð¼ð‘Ÿð‘’ð‘“âŸ©ð‘£ðœŽ(ð¼ð‘š)ð‘£ . ðœŽ(ð¼ð‘Ÿð‘’ð‘“)ð‘£(3) According to (Cachier et al., 2003), the mean and standard deviation at each voxel v are computed using a Gaussian kernel KG, with a standard deviation of Nstd = 0.9 cm, through the convolution process: ð¼ð‘šÌ…Ì…Ì…Ì…ð‘£ = ð¾ðº  âˆ— ð¼ð‘š ðœŽ(ð¼ð‘š)ð‘£ = âˆšð¼ð‘šð‘£2Ì…Ì…Ì…Ì…Ì… âˆ’  ð¼ð‘šð‘£Ì…Ì…Ì…Ì…Ì…2= âˆš(ð¾ðº  âˆ—  ð¼ð‘š2) âˆ’ (ð¾ðº  âˆ— ð¼ð‘š)2 Ì…Ì…Ì…Ì…Ì…Ì…Ì…Ì…Ì…Ì…Ì…âŸ¨ð¼ð‘š, ð¼ð‘Ÿð‘’ð‘“âŸ©ð‘£ = ð¼ð‘š. ð¼ð‘Ÿð‘’ð‘“ð‘£ âˆ’  ð¼ð‘šÌ…Ì…Ì…Ì…ð‘£. ð¼ð‘Ÿð‘’ð‘“Ì…Ì…Ì…Ì…Ì…Ì…ð‘£ = (ð¾ðº  âˆ— ð¼ð‘š. ð¼ð‘Ÿð‘’ð‘“) âˆ’ ((ð¾ðº  âˆ— ð¼ð‘š ). (ð¾ðº  âˆ— ð¼ð‘Ÿð‘’ð‘“))  (4) The range of LNCC values varies considerably among the subjects and locations within a patient. Moreover, since the LNCC is calculated voxelwise, the output is prone to noise and local uncertainty arising from the lack of sufficient local information in the images (Burgos et al., 2014; Yushkevich et al., 2010). To overcome these shortcomings of LNCC similarity measure, k-nearest neighbour kernel was employed to pool the information in the near vicinity in order to choose the most similar image to the target image from the atlas database (Altman, 1992). To this end, in the first step, the LNCC is calculated for each voxel of the target in-phase image across all the co-registered atlas images using equations (4) and (5). Then, for each voxel, the most similar atlas to the target image is selected on the basis of its k-nearest neighbour LNCC values. To minimize the impact of noise, a fixed size window is defined around the target voxel and the atlas with the highest score within the window is selected as the most similar atlas for that voxel. It should be noted that negative LNCC scores were converted to zeros before the k-nearest filtering. The information about selected atlases is stored in the ASM(x), the 9    atlas selection matrix, whose voxels indicate IDs of the most similar atlas images to the target. Optimization of the k-nearest neighbour (as described in section 2.4) led to a window size of 5 cm Ã— 5 cm (defined in 2D on each slice). A large window size guarantees robust similar atlas selection carried out by the LNCC process. Although using a wide Gaussian kernel for the LNCC step may lead to similar outcome as the k-nearest filter, exploiting the k-nearest filter resulted in more robust similarity measure between large image patches. Figure 2 depicts a representative sample of the ASM with its corresponding in-phase image where each colour stands for one individual image in the atlas dataset that is locally most similar to the target image. The LNCC metric enables to detect and eliminate the causes of error due to misalignment and anatomical dissimilarity across the aligned atlas dataset. In the presence of morphological discrepancy (owing to registration errors or anatomical dissimilarity) between the target and atlas images, the LNCC analysis yields relatively low scores thus triggering the elimination of the corresponding atlas (or sub-volume) from further processing (supplemental figure 1). After constructing the ASM, the GPR algorithm for non-lung region is run on the most similar atlas images on a voxel by voxel basis using the ASM data. This method employs the above described Gaussian process regression but splits the main kernel in equation (1) into two separate Gaussian processing kernels for non-lung and lung tissues. Figure 3 depicts a schematic diagram of the SAP approach summarizing the different steps required to generate a pseudo-CT image. In fact, two distinct Gaussian process regressions are trained and utilized separately for lung and non-lung body regions. For non-lung region, the Gaussian kernel is modified as follows: ð¾ð‘›ð‘œð‘›âˆ’ð‘™ð‘¢ð‘›ð‘”(ð‘ð‘–, ð‘ð‘—) = exp (2âˆ’â€–ð‘€ð‘…ð‘,ð‘–âˆ’ ð‘€ð‘…ð‘,ð‘—â€–2ðœŽð‘€ð‘…,ð‘ð‘™ð‘¢ð‘ ð‘¡ð‘’ð‘Ÿ2) Ã—  exp (âˆ’â€–ð‘‹ð‘–âˆ’ ð‘‹ð‘—â€–22ðœŽð‘ð‘œð‘ 2)  (5) where, bi and bj=(MRc,j , Xj) represent the vector of information extracted from MRI training dataset for voxels i/j=1,2,â€¦,n and MRc and X represent the voxel value (cluster level between 1 to 512) and position in the clustered atlas MR images, respectively. As mentioned earlier, the voxel value in the clustered MR images is used in our approach instead of weighted averages of voxels within patches of the image used by Hofmann et al. (Hofmann et al., 2011). In this way, the 9mm Ã— 9mm patches of voxels (defined in 2D on each slice) in Hofmannâ€™s method are replaced by the cluster number of the target voxel. As such, the parameter ÏƒMR,patch in Eq. (1) is replaced by ÏƒMR,cluster. Comparing equations (1) and (3), the term dealing with similarity in the 5-class segmented MR image has been omitted in the modified version of the algorithm since it was found to have negligible influence on the output. 10  Figure 2. A) In-phase Dixon image of the target patient and B) Target patient atlas selection matrix where each colour stands for one particular image in the atlas dataset. Figure 3. Schematic diagram of the SAP methodâ€™s workflow. In fact, in the SAP method, the atlas registration is carried out on denoised MR images as described in section 2.2 (before clustering) and the aligned images are further processed using the LNCC algorithm. After determining the most similar atlas for each voxel in the target image, the selected atlases in the ASM undergo a clustering process before being fed to the GPR kernel. The training and pseudo-CT generation are performed using the GPR kernel running over the most similar atlas for each voxel according to the information provided by the ASM. The information for each voxel from MR atlas images is extracted in the form of clusters rather than patches of voxels as opposed to what is done in the original method. In other words, the LNCC step is run over the original MR images and 11   after determining the most similar atlas for each region, an MR â€œcompositeâ€ image is constructed using the corresponding regions from the clustered image. Thereafter, the GPR is run over the MR composite image (with clustered intensity) and the clustered target image. Thus, the clustering is performed one step before constructing the MR composite image. Alternatively, the LNCC could be run over the clustered MR images provided a large number of cluster bins is used. Otherwise, it may skew the similarity measurement. In contrast, in Hofmannâ€™s method, the GPR kernel is built based on patches of voxels (not clustered images) and run non-selectively over the entire registered images. 2.3.3 Lung attenuation coefficients estimation We propose a separate Gaussian kernel for estimation of lung attenuation coefficients. To this end, the kernel in equation (3) is modified but the term regarding the intensity similarity between target and atlas MR images remained unchanged in equation (6) on the ground that there is potentially a correlation between MR intensity and CT attenuation coefficients (Kapanen and Tenhunen, 2013). On the other hand, the position similarity term was replaced with lung volume proximity (Vaj and Vai) where the ai and aj denote the atlas index of the corresponding i and j clusters, respectively (the Vaj and Vai refer to the lung volumes of atlases, which the clusters MRc,i and MRc,j are taken from). ð¾ð‘™ð‘¢ð‘›ð‘”(ð‘™ð‘–, ð‘™ð‘—) = exp (2âˆ’â€–ð‘€ð‘…ð‘,ð‘–âˆ’ ð‘€ð‘…ð‘,ð‘—â€–2ðœŽð‘€ð‘…,ð‘ð‘™ð‘¢ð‘ ð‘¡ð‘’ð‘Ÿ2)  Ã— ð‘’ð‘¥ð‘ (2âˆ’â€–ð‘‰ð‘Žð‘–âˆ’ ð‘‰ð‘Žð‘—â€–2ðœŽð‘™ð‘¢ð‘›ð‘” ð‘£ð‘œð‘™ð‘¢ð‘šð‘’2)  (6) It is hypothesized that the lung intensity is correlated with the lung volume (Lonn and Wollenweber, 2012). In order to evaluate the degree to which lung attenuation coefficients are correlated with the lung volume, CT images of 50 patients (31 male and 19 female; age ranging from 35 to 96 years) chosen randomly from the clinical database without any preference acquired in free shallow breathing were examined. All the 50 patients were administered whole-body 18F-FDG PET/CT acquired on a Biograph 64 True Point scanner (Siemens Healthcare, Erlangen, Germany) using the protocol described in section 2.1. The technique described in section 2.2 was employed to segment the lungs from CT images. Thereafter, the average lung attenuation coefficient vs. volume was plotted (Figure 4). Taking advantage of the established correlation between lung volume and density, the additional information regarding the lung volume was incorporated in the lung GPR kernel (Klung) using the weight Ïƒlung volume. Splitting up the original kernel gives us the possibility to include lung tissue characteristics into lung-specific kernel. The lung volume term added to the kernel (Eq. 6) tends to predict lung attenuation coefficients considering the close relationship of lung volume between the target and atlas images. 12  Figure 4. Correlation plots between lung attenuation coefficients (HU) vs. lung volume obtained from CT image segmentation of 50 patients. In addition, a simple technique was devised to estimate the attenuation coefficients of prospective malignant lesions in the lungs which might have a different density. PET images corrected for attenuation using the 3-class Âµ-map (PET-MRAC3c) were analyzed to detect lung tumours. To this end, a lung mask obtained from segmentation of in-phase MR images was overlaid (after resolution matching) on PET-MRAC3c images and a threshold of 2.5 SUV was applied on voxels located within the lung mask (Chen et al., 2013). Voxels with an SUV higher than 2.5 were considered as belonging to the lesion and were assigned soft-tissue attenuation coefficient in the pseudo-CT attenuation map. Since noisy voxels in the lungs with spurious SUV over 2.5 might be mapped to soft-tissue, 3D median filtering with a kernel dimension of 3Ã—3Ã—3 was applied to PET-MRAC3c images before thresholding followed by connectivity analysis (Rosenfeld and Kak, 1982) to exclude regions having a maximum diameter below 4 mm based on recommendations in (Wahl et al., 2009). In the final step, an automatic post-processing rule is applied on the generated pseudo-CT images to account for gas pockets in the abdomen area. First, the bone tissue is segmented using an intensity threshold of 140 HU. Then a distance map (Danielsson, 1980) is computed on the obtained binary bone map. The voxels that have a low MRI intensity in the target in-phase image and reside at least 10 mm far from nearest bony structures are assumed to belong to massive and mobile air cavities with a 13  pseudo-CT value of -1,000 HU. This procedure enables to detect air cavities (particularly in the abdomen) even when there is no similar structure in the atlas database. 2.4. Parameter optimization We employed a leave-one-out cross-validation (LOOCV) scheme to find the optimum value for all free parameters and settings. In the first step, MR images are non-rigidly aligned to the corresponding CT images ensuring appropriate MRI-CT matching. The coregistered images are carefully checked visually and in case of misalignment, the registration parameters, such as final grid space and optimisation parameters are tuned to achieve the best possible alignment between MR and CT images. The aligned atlas dataset is created using 13 out of the 14 available clinical studies. As such, for each individual patient, all the remaining 13 in-phase MR images were deformably registered to the target image. The k-nearest window in the LNCC step plays a key role in the implementation of our SAP method. Voxelwise searching for the most similar atlas through the window of k-nearest neighbour was optimized via varying the window size from 1 to 10 cm with a step of 1 cm and the resulting pseudo-CT images were evaluated in terms of bone extraction accuracy at each step. To this end, the Dice similarity measure was employed to evaluate the accuracy of extracted bone from the resulting pseudo-CT images considering the bone map extracted from CT images as reference. This procedure was repeated for the whole dataset and the highest Dice metric was achieved at a window size of 5 cm Ã— 5 cm. The parameters Ïƒpos, ÏƒMR,patch and ÏƒSeg,patch are the most influential factors in the original kernel. Firstly, the associated parameters were roughly determined for each test patient through examination of the variance of patch intensity, position and segmentation terms in Eq. (1). The exact parameter setting was empirically achieved through pseudo-CT generation for each of the 14 atlas images. The parameters that maximized the similarity between pseudo-CT and actual CT images were selected. The similarity between the resulting pseudo-CT and actual CT images was assessed based on the Dice metric for bone volume as described earlier. A patch size of 9Ã—9 voxels was used to feed the GPR kernel and for each target voxel, 80 patches of voxels were chosen to train the kernel. A higher sampling density (120 samples) was used near bone regions as they are of special interest. The same procedure was followed to train the non-lung SAP kernel and setting of the parameters ÏƒMR,cluster and Ïƒpos. Since a separate kernel was employed for the lung tissue in the SAP method, all the patches were sampled outside the lung volume (inside the body contour) with the same sampling density to train the kernel in Eq. (3). The training of Eq. (6) was performed in a similar way, except that all the patches were chosen inside the lung volume using 80 patches for each target voxel. The associated parameters for lung-kernel (Ïƒlung volume and ÏƒMR,cluster) were optimized through the same scheme described above but instead 14  of the Dice metric, the absolute lung attenuation difference between pseudo-CT and actual CT images was used for parameter tuning. 2.5. Quantitative evaluation Pseudo-CT images were generated for the 14 clinical studies and the obtained attenuation maps used for attenuation correction of corresponding PET data. Calculations were performed on a PC equipped with Intel Xeon CPU (2.3 GHz) running Matlab. It took approximately 1100 min on average to create one pseudo-CT image (almost 70% for the atlas registration and 25% for the GPR training). PET images were reconstructed by means of the e7 tool (Siemens Healthcare, Knoxville, TN) using ordinary Poisson ordered subset-expectation maximization (OP-OSEM) iterative reconstruction algorithm. Default parameters (4 iterations, 8 subsets, and a post-processing Gaussian kernel with a FWHM of 5 mm) adopted in clinical protocols were applied. Image reconstruction was performed four times for each clinical study: PET images corrected for attenuation using CT (PET-CTAC) used as reference, using the 3-class attenuation map (PET-MRAC3c) obtained from the Ingenuity TF PET/MR scanner (Schulz et al., 2011), using the pseudo-CT generated by Hofmannâ€™s approach (PET-HofmannAC) (Hofmann et al., 2011) and our proposed SAP approach (PET-SAPAC). A nuclear medicine physician drew manually the VOIs on regions of normal physiologic uptake, six regions in the lungs (on the upper, middle and lower parts of the right and left lung), liver, spleen, cerebellum, 2 bony structures (cervical vertebrae 6 and dorsal vertebrae 5), aorta, and malignant lesions (Arabi et al., 2015). The VOIs were carefully drawn at the centre of each organ far away from organ boundaries. The differences between the attenuation correction techniques were quantified in terms of change in the standard uptake value (SUV). The SUVs were calculated by dividing the activity concentration in each VOI by the injected activity divided by body weight. The accuracy of attenuation correction was assessed through the relative mean error (Eq. 7) and relative mean absolute error (Eq. 8) between SUV measured on PET attenuation corrected using MR-derived attenuation maps (MRAC) and PET attenuation corrected using reference CT image averaged over all patients. In addition to the ROI-based analysis, anatomical regions corresponding to the liver, cerebellum, cervical vertebrae 6, dorsal vertebrae 5 and spleen were segmented on CT images using the ITK-SNAP software and the same PET quantitative evaluation was carried out.           ð‘…ð‘’ð‘™ð‘Žð‘¡ð‘–ð‘£ð‘’ ð‘’ð‘Ÿð‘Ÿð‘œð‘Ÿ (%) = ð‘€ð‘…ð´ð¶ (ð‘†ð‘ˆð‘‰) â€“ ð‘…ð‘’ð‘“ð‘’ð‘Ÿð‘’ð‘›ð‘ð‘’ (ð‘†ð‘ˆð‘‰)ð‘…ð‘’ð‘“ð‘’ð‘Ÿð‘’ð‘›ð‘ð‘’ (ð‘†ð‘ˆð‘‰) Ã— 100%     (7) ð‘…ð‘’ð‘™ð‘Žð‘¡ð‘–ð‘£ð‘’ ð‘Žð‘ð‘ ð‘œð‘™ð‘¢ð‘¡ð‘’ ð‘’ð‘Ÿð‘Ÿð‘œð‘Ÿ (%) = ð´ðµð‘†[ð‘€ð‘…ð´ð¶ (ð‘†ð‘ˆð‘‰) â€“ ð‘…ð‘’ð‘“ð‘’ð‘Ÿð‘’ð‘›ð‘ð‘’ (ð‘†ð‘ˆð‘‰)]ð‘…ð‘’ð‘“ð‘’ð‘Ÿð‘’ð‘›ð‘ð‘’ (ð‘†ð‘ˆð‘‰) Ã— 100%     (8) In addition to ROI-based analysis, voxel-based comparison was carried out between PET images corrected for attenuation using the two pseudo-CT images and PET-CTAC used as reference. The voxel-based relative mean bias (RMB) and relative mean absolute bias (RMAB) were computed for bone, lung, fat and soft-tissue class using equations (7) and (8), respectively. The segmentation of 15  tissue classes was performed based on CT Hounsfield units (HU) using the following thresholds; bone if HU â‰¥ 140, soft-tissue if -20 < HU â‰¤ 140, and fat if -350 < HU â‰¤ -20. The lung mask was obtained as described in the data processing section. The assessment of the accuracy and robustness of the extracted bones using the proposed (SAP) and Hofmannâ€™s approaches was performed through comparison with the bone segmented from the corresponding CT images. Bone segmentation was performed by applying a threshold of 140 HUs on the generated pseudo-CT and corresponding CT images. The validation of bone segmentation is reported using seven volume/distance-based metrics (Ay et al., 2014): Dice similarity (DSC) (Dice, 1945), relative volume difference (RVD) (Heimann et al., 2009), Jaccard similarity (JC) (Collins and Pruessner, 2010), sensitivity (S) (Xia et al., 2013), mean absolute surface distance (MASD) (Gerig et al., 2001), Hausdorff distance (HD) (Crum et al., 2006) and distance error (DE) (Klein et al., 2009). ð·ð‘†ð¶(ð´, ð‘€) =2|ð´ âˆ© ð‘€||ð´| + |ð‘€|ð‘…ð‘‰ð·(ð´, ð‘€) = 100 Ã—|ð‘€| âˆ’ |ð´||ð´|ð½ð¶(ð´, ð‘€) =ð‘†(ð´, ð‘€) =|ð´ âˆ© ð‘€||ð´ âˆª ð‘€||ð´ âˆ© ð‘€||ð‘€|ð‘€ð´ð‘†ð·(ð´, ð‘€) =ð‘‘ð‘Žð‘£ð‘’ (ð‘†ð´,ð´ð‘€) + ð‘‘ð‘Žð‘£ð‘’ (ð´ð‘€,ð‘†ð´)2                                       ð·ð¸(ð´, ð‘€) =1ð‘âˆ‘ ð‘šð‘–ð‘›ð‘‘ð‘–ð‘ ð‘¡(ð´ð‘, ð‘€ð‘)ð‘ð‘=1 ð»ð·(ð´, ð‘€) = max{minð‘€ð´{ð‘‘(ð´, ð‘€)} }            (9) where A is the bone segmented from the reference CT image and M denotes the extracted bone from the pseudo-CT attenuation maps. dave(SA,SM) is the average direct surface distance from all points on the CT bone surface SA and to the pseudo-CT bone surface SM. The distance error is equal to the minimum distance from each boundary point of the source region (Ap) to the entire set of points of the target region (Mp) averaged across the N boundary points. The Hausdorff distance measures the maximum distance one would need to move the boundaries of the source region (A) to completely cover the target region (M). Moreover, the generated pseudo-CTs were compared to the ground truth CT through metrics measuring the voxel-wise error (in HUs) between bone volumes using the mean error (ME) and mean absolute error (MAE) defined as: ð‘€ð¸ =ð‘£âˆ‘ (MCTð‘£âˆ’CTð‘£)ð‘‰ð‘€ð´ð¸ =ð‘£âˆ‘ |MCTð‘£âˆ’CTð‘£|ð‘‰(10) (11) where V is the number of voxels in the bone volume, MCTv and CTv denote voxel values in the pseudo-CT and ground truth CT images, respectively. 16                 Furthermore, we expanded our evaluation by separating cortical bone (>300 HUs) from spongy bone (140-300 HU) by thresholding reference CT images and generated pseudo-CT images. Then, all the above mentioned segmentation accuracy measures were applied separately on the segmented spongy and cortical bones to precisely quantify the performance of the proposed method. The accuracy of the predicted lung attenuation coefficient was evaluated by calculating the average lung attenuation coefficient on the obtained pseudo-CT images using a lung mask and comparing it with the corresponding CT images for each individual patient. Paired t-test analysis was used to assess if the differences between the obtained results are statistically significant. A threshold of 0.05 was used for statistical significance. 3. Results Figure 5 depicts a representative sagittal slice of the generated pseudo-CT attenuation map along with corresponding in-phase MR and CT images. The visual inspection of images revealed sharper bone edges when using our SAP approach. Figure 5. A) Target patient CT image, B) corresponding in-phase MR image, and attenuation maps generated using C) Hofmannâ€™ technique and D) our proposed SAP approach. According to Table 1, considerable bone detection enhancement was achieved using the SAP attenuation map based on the average of 14 patients. However, the differences were not statistically different for all metrics. Figure 6 illustrates the segmented bone of the clinical study shown in figure 5 using Hofmannâ€™s and SAP approaches. Figures 5D and 5E depict the corresponding distance error maps calculated by comparing segmented bones using Hofmannâ€™s and SAP attenuation maps with the CT-based attenuation map. A relatively smaller average distance error is achieved by SAP (7 mm max) compared to Hofmannâ€™s method (12 mm max). Table 1. Comparison of cortical bone (>300 HU) and spongy bone (140-300 HUs) segmentation accuracy (meanÂ±SD) between Hofmannâ€™s and SAP approaches using various evaluation metrics including Dice similarity (DSC), relative volume distance (RVD), Jaccard similarity (JC), sensitivity (S), mean absolute surface distance (MASD), Hausdorff distance (HD), distance error (DE), mean absolute error (MAE) and mean error (ME). 17  Hofmann P-value SAP P-value DSC RVD (%) JC S (All bones cortical spongy) 0.58Â±0.09 0.53Â±0.09 0.57Â±0.08 -36.6Â±10.0 -41.2Â±11.0 -38.9Â±10.0 0.35Â±0.06 0.31Â±0.05 0.33Â±0.06 0.40Â±0.15 0.37Â±0.14 0.39Â±0.15 MASD (mm) 6.92Â±3.10 HD (mm) DE (mm) MAE (HU) ME (HU) 7.32Â±3.40 7.12Â±3.00 15.9Â±4.70 16.3Â±4.80 16.1Â±4.70 2.6Â±1.70 2.8Â±1.65 2.7Â±1.72 127Â±26.0 135Â±27.4 132Â±26.8 -29Â±32.0 -31Â±32.8 -30Â±32.3 (All bones cortical spongy) 0.65Â±0.07 0.60Â±0.06 0.64Â±0.07 -30.7Â±9.10 -34.2Â±8.90 -32.8Â±9.20 0.41Â±0.05 0.38Â±0.04 0.40Â±0.05 0.48Â±0.12  0.43Â±0.12 0.47Â±0.11 4.81Â±2.60 4.92Â±2.53 4.99Â±2.61 10.9Â±3.80 11.4Â±3.79 11.2Â±3.83 1.1Â±0.90 1.2Â±0.92 1.1Â±0.89 89Â±12.5 93Â±12.9 91Â±12.4 -11Â±20.0 -12Â±23.2 -11Â±22.8 0.10 0.10 0.09 0.23 0.25 024 0.15 0.16 0.15 0.11 0.12 0.11 0.08 0.08 0.08 0.09 0.09 0.09 <0.05 <0.05 <0.05 <0.05 <0.05 <0.05 0.06 0.06 0.06 <0.05 <0.05 <0.05 0.17 0.18 0.17 0.10 0.10 0.10 0.08 0.08 0.08 <0.05 <0.05 <0.05 <0.05 <0.05 <0.05 <0.05 <0.05 <0.05 <0.05 <0.05 <0.05 <0.05 <0.05 <0.05 18   Figure 7 compares the average lung attenuation coefficient obtained using both MRI-derived pseudo-CT approaches compared with the actual coefficient obtained from CT images for each individual patient. The lung attenuation coefficient predicted by Hofmannâ€™s approach is very close to the average attenuation coefficient of the atlas database resulting in an average lung attenuation estimation error of 7.92Â±20% (averageÂ±SD) over all patients using CT as reference, whereas the SAP approach yielded an error of -0.25Â±8% (in terms of linear attenuation coefficients at 511 keV). The errors in HUs were 8.14Â±35 and -1.71Â±14, respectively, indicating a lower SD for the SAP method. Figure 6. Representative slice of bone segmentation from MR images showing: A) Binary image of segmented bone from CT images, segmented bone using B) Hofmannâ€™ technique and C) our proposed SAP approach. Distance error map calculated by comparing Hofmannâ€™ technique D) and our SAP approach E) with the 19 1234567891011121314-720-770-820-870PatientAttenuation value (HU) HofmannCTSAP reference bone segmented on CT images. Figure 7. Predicted average lung attenuation coefficients using Hofmannâ€™s and the proposed SAP approaches compared to actual value obtained from CT images of each individual patient averaged over the whole lung volume. Figure 8 illustrates a clinical study presenting with non-small cell lung cancer. The lesion was overlooked by the 3-class segmentation procedure implemented on the Philips TF PET/MR system (Figure 8D) and consequently assigned the wrong attenuation coefficient of the lung (0.022 cm-1). The SUVmean of the lesion is 6.1 for PET-MRAC3c (figure 8H) significantly underestimates the SUVmean for PET-CTAC (9.7) serving as reference owing to the assignment of the wrong attenuation coefficient to the lesion. Figure 8E shows the same 3-class attenuation map with correct identification of the lung lesion using the proposed PET segmentation technique and proper assignment of soft-tissue attenuation coefficient. The measured SUVmean of the lesion after correction (PET-CorrectedMRAC3c) is 7.8 (figure 8I). Due to the low MR intensity of the lung lesion, Hofmannâ€™s approach fails to assign the correct attenuation coefficient to the lesion (figure 8F), thus leading to underestimation of SUVmean of (8.2) (figure 8J). Yet, our SAP approach correctly identified the lung lesion (figure 8G), leading to an SUVmean of 9.5 on PET-SAPAC (figure 8K). Figure 8. Representative slices showing a clinical study with non-small cell lung cancer with a lesion in the left lung. A) CT, B) in-phase MRI, C) PET-CTAC, D) 3-class attenuation map, E) corrected using the 3-class attenuation map where the attenuation coefficient of soft-tissue is assigned to the lung lesion, attenuation maps generated using F) Hofmannâ€™s and G) our SAP approaches, H) PET-MRAC3c, I) PET-correctedMRAC3c, J) PET-HofmannAC and K) PET-SAPAC. Voxelwise SUV bias maps obtained by comparing PET-CTAC and L) PET-MRAC3c, M) PET-correctedMRAC3c, N) PET-HofmannAC and O) PET-SAPAC, respectively. The 20  estimated SUVmean in the malignant lesion was 6.1 for PET-MRAC3c, 7.8 for PET-CorrectedMRAC3c, 8.2 for PET-HofmannAC, and 9.5 for PET-SAPAC. The latter is closer to SUVmean of 9.7 obtained on PET-CTAC serving as reference. The patient bed derived from CT images was inserted in all attenuation maps; however, some bias, particularly at the back of the patient, might stem from slight bed mispositioning. Figure 9 shows the relative errors between SUVmean estimated using PET images corrected for attenuation using SAP and Hofmannâ€™s approaches and PET-CTAC images taken as reference. Significant improvement in the accuracy of SUV estimates was achieved in bony structures (cervical 6 and dorsal 5) and structures located near cortical bone (cerebellum and some malignant lesions). Furthermore, the SAP approach decreased considerably the standard deviation of the estimated SUVmean in the lungs. The SUV underestimation using the 3-class approach in or near bony structures such as the cerebellum and vertebrae is larger with errors of -13.0Â±6.2% and -27.4Â±10.1%, respectively. In contrast, Hofmann and SAP approaches yield relative errors of -8.8Â±3.8% and -7.3Â±6.0%, and -3.3Â±04.9% and -1.7Â±4.8%, respectively (Table 2). Figure 9. Mean relative errors (bias) of SUVmean for PET images reconstructed using Hofmannâ€™s and SAP attenuation correction techniques for VOIs corresponding to 12 normal uptake regions and 36 malignant lesions. 21  Table 2. Mean relative errors (bias) between SUVmean estimated using PET images corrected for attenuation using MRI-guided three-class (MRAC3c), Hofmannâ€™s and SAP (SAPAC) attenuation correction techniques and CT-based attenuation correction used as reference. Region MRAC3c P-value Hofmann P-value SAPAC P-value Upper right lung 21.8Â±10.2 Upper left lung 18.7Â±10.4 Middle right lung 19.3Â±15.8 Middle left lung 21.0Â±18.1 Lower right lung 20.8Â±21.2 Lower left lung 06.6Â±15.1 Cerebellum Aorta cross Liver Spleen -13.0Â±6.2 -15.8Â±8.6 -11.2Â±7.0 0.39 0.27 0.30 0.33 0.34 0.10 0.07 0.06 0.05 04.9Â±17.2 <0.02 02.4Â±7.3 07.0Â±15.4 <0.05 00.3Â±7.2 08.4Â±15.4 0.06 01.6Â±7.5 -06.5Â±11.3 <0.02 01.9Â±7.6 <0.01 <0.01 <0.01 <0.01 02.3Â±20.2 <0.01 -04.8Â±9.8 <0.05 -07.3Â±12.0 <0.05 -03.0Â±7.2 0.05 -08.8Â±3.8 <0.05 -03.3Â±4.9 <0.01 -02.7Â±4.7 <0.01 -02.3Â±3.5 <0.01 -05.8Â±3.8 <0.05 -04.1Â±4.7 <0.05 -10.0Â±10.4 0.05 00.2Â±3.5 <0.01 -00.6Â±4.5 <0.01 Bone (cervical 6) -29.9Â±10.0 0.43 -08.7Â±6.52  0.05 -02.8Â±5.5 <0.01 Bone (dorsal 5) -25.0Â±10.2 0.40 -05.8Â±5.5 <0.01 -00.6Â±4.0 <0.02 Lesions -03.7Â±9.1 0.03 -02.2Â±7.5 <0.01 -01.4Â±4.2 <0.01 The relative mean absolute errors together with min-max intervals are summarized in Table 3 to examine the precision of MRI-guided attenuation correction techniques. The 3-class attenuation map assigning a uniform attenuation coefficient of 0.022 cm-1 (-770 HU) to the lungs produces a relative absolute error of 21.7Â±11.8%. This was reduced on average to 15.8Â±8.6% and 8.0Â±3.8% when using Hofmann and SAP techniques, respectively. Average and standard deviations of voxelwise RMB and RMAB between the ground truth PET-CTAC and PET-MRAC3c, PET-SAPAC and PET-HofmannAC computed for lung, fat, soft-tissue and bone regions are summarized in Table 4. Region MRAC3c [min, max]% Hofmann [min, max]% SAPAC [min, max]% 22      Upper right lung 24.3Â±9.5 [45.4, 1.0] 17.7Â±13.0 [-39.2, 43.3] 7.5Â±3.4 [-9.5, 16.7] Upper left lung 20.3Â±9.4 [-1.6, 46.9] 15.1Â±8.8 [-16.5, 31.7] 7.3Â±4.2 [-17.4, 13.0] Middle right lung 21.0Â±11.2 [0.0, 56.2] 16.7Â±7.1 [-15.5, 39.7] 7.1Â±3.4 [-8.9, 16.3] Middle left lung 24.5Â±14.1 [-10.3, 50.6] 12.8Â±6.3 [-29.4, 15.6] 8.2Â±3.3 [-11.8, 15.0] Lower right lung 25.1Â±17.2 [-12.3, 55.6] 20.2Â±8.2 [-43.3, 28.9] 10.5Â±4.3 [-21.6, 11.1] Lower left lung 15.0Â±9.8 [-26.8, 32.0] 12.6Â±8.4 [-31.3, 15.4] 7.6Â±3.9 [-19.1, 8.5] Cerebellum 15.4Â±5.3 [-29.5, -01.1] 9.2Â±3.3 [-17.1, 3.0] 5.6Â±2.9 [-14.5, 6.8] Aorta cross 17.9Â±7.6 [-38.6, -01.0] 5.1Â±2.7 [-10.8, 7.6] 4.2Â±2.5 [-7.7, 8.6] Liver Spleen 14.2Â±8.1 [-21.0, 1.4] 6.2Â±3.5 [-12.7, 1.7] 6.5Â±2.4 [-12.7, 7.7] 16.0Â±9.4 [-19.1, 1.0] 3.4Â±2.5 [-07.6, 10.0] 4.6Â±3.3 [-10.8, 11.1] Bone (cervical 6) 33.6Â±11.3 [-51.5, -13.0] 10.5Â±5.0 [-18.7, 3.2] 5.8Â±2.9 [-8.6, 6.5] Bone (dorsal 5) 27.2Â±10.2 [-41.0, -1.1] 6.7Â±4.8 [-20.3, 7.0] 4.2Â±2.4 [-14.3, 7.4] Lesions 09.8Â±4.5 [-31.0, 21.4] 8.3Â±6.1 [-14.4, 21.4] 6.1Â±3.4 [-17.5, 15.9] Table 3. Mean relative absolute errors between SUVmean estimated using PET images corrected for attenuation using MRI-guided three-class (MRAC3c), Hofmannâ€™s and SAP (SAPAC) attenuation correction techniques and CT-based attenuation correction used as reference. Table 4. Average and standard deviation of the voxelwise RMB and RMAB results between PET-MRAC3c, PET-SAPAC and PET-HofmannAC and the ground truth PET-CTAC computed for lung, fat, soft-tissue and bone classes [RMB meanÂ±SD (RMAB meanÂ±SD)]. Method Lung Fat Soft-tissue Bone MRAC3c 15.8Â±10.1 1.8Â±8.3 -9.6Â±8.2 -19.9Â±11.5 (18.6Â±7.4) (5.1Â±5.8) (11.7Â±6.1) (20.7Â±9.8) SAPAC -1.0Â±6.8 1.2Â±5.9 -3.4Â±5.2 -0.7Â±7.8 Figure 10 depicts (7.8Â±4.9) (6.6Â±4.4) (5.7Â±4.1) (6.8Â±5.9) an Hofmann 3.9Â±11.7 6.5Â±7.1 -4.9Â±6.7 -6.0Â±7.9 (10.9Â±7.6) (9.8Â±6.2) (7.2Â±5.3) (9.7Â±6.1) example of metal artefacts portrayed on the MR image and its impact on the attenuation maps produced by the various strategies as well as the resulting PET images. The 3-class attenuation map generated by the Ingenuity TF PET/MR scanner (figure 10C) gave rise to body truncation reflected by the presence of a gap 23     correlated with the void signal produced by MR in the presence of metallic objects. Given that metal implants usually replace bony structures, most atlas images predict bones for these regions. As such, both Hofmann and SAP approaches assigned close to bone attenuation coefficients to metallic objects, albeit the SAP attenuation map exhibited a higher contrast (figure 10D and E). The SUVmean measured at the site of the metallic object (a large ROI was defined to cover the surrounding tissue) is 1.9, 0.7, 1.2 and 1.1 for PET-CTAC (figure 10F), PET-3CAC (figure 10G), PET-HofmannAC (figure 10H) and PET-SAPAC (figure 10I), respectively. It should be emphasized that it is likely that the SUV for the PET-CTAC doesnâ€™t reflect the actual value owing to the corruption of the CT images by metallic artefacts. Figure 10. Impact of metallic artefacts. A) In-phase MRI, B) CT, attenuation map generated using C) 3-class attenuation map, D) Hofmannâ€™s technique, and E) our SAP approach. Corresponding attenuation corrected PET images: F) PET-CT, G) PET-MRAC3c, H) PET-HofmannAC and I) PET-SAPAC. Voxelwise SUV bias maps obtained by comparing PET-CTAC and J) PET-MRAC3c, K) PET-HofmannAC and L) PET-SAPAC. The estimated SUVmean were 1.8 for PET-CT, 0.7 for PET-MRAC3c, 1.0 for PET-HofmannAC, and 1.2 PET-SAPAC. 4. Discussion In this work, we focused on the accuracy of bone extraction as the most challenging issue in MRI-guided attenuation correction in PET/MRI. The visual inspection of figure 5 and the results presented in Table 1 revealed that superior bone extraction accuracy was achieved using our SAP approach 24  (figure 5D). Since Hofmannâ€™s approach relies only on local similarity measure provided by the GPR kernel, thus lacking a semi-global scheme (such as the LNCC step) to discard misaligned atlases, the corresponding attenuation map (figure 5C) suffers from the lack of consensus in the warped atlas dataset. Owing to the superior performance of our approach for bone extraction, the mean relative error (relative mean absolute error) decreased from -8.7Â±6.5% (10.5Â±5.0%) to -2.8Â±5.5% (5.8Â±2.9%) for cervical 6 and from -5.8Â±5.5 (6.7Â±4.8%) to -0.6Â±4.0% (4.2Â±2.4)% for dorsal 5 when using SAP compared to Hofmannâ€™s approach. The mean relative error of SUVmean estimation in soft-tissue regions, such as the aorta cross, liver and spleen, didnâ€™t show significant differences between SAP and Hofmannâ€™s techniques according to the ROI-based analysis (Tables 2 and 3 and figure 9), since in both attenuation maps, these areas are filled with an average soft-tissue attenuation coefficient and are far from cortical bone (Marshall et al., 2013; Ouyang et al., 2013). This is in agreement with observations made by Bezrukov et al. (Bezrukov et al., 2013b) who reported that filling areas far from bony structures with soft-tissue and fat attenuation coefficients had no significant impact on PET quantification. The atlas selection strategy primarily brings improvement to bone identification while fat and/or soft-tissue regions (particularly those far from bony structures) are less affected. In this regard, voxelwise SUV bias analysis (Table 4) and anatomical regions analysis (Supplemental Table 1) demonstrate slight improvement in soft-tissue class while more pronounced bias reduction is observed in bony regions. The high negative bias for bony structures observed when using PET-MRAC3c (due to ignoring bone) is consistent with results reported in the literature, namely, -15% (Ouyang et al., 2013), -18% (Kim et al., 2012), -29% and -16% (Hofmann et al., 2011), -35% and -25% (Marshall et al., 2013). Likewise, similar SUV bias reduction was observed after including bones in the attenuation map (Hofmann et al., 2011; Marshall et al., 2013). Although the mean SUV bias in lesions when using the 3-class technique is only 3.9% (with a relative mean absolute error of 9.8Â±4.5%), the absolute SUV difference between PET-MRAC3c and PET-CTAC is larger compared to other regions with a maximum SUV value of 2 for one lesion, causing a bias of -31.0%. The average of mean relative absolute errors obtained in six lung regions decreased from 15.8Â±8.6% to 8.0Â±3.8% when using Hofmann and SAP approaches, respectively (Table 3). Apart from the overall SUV bias reduction, the standard deviation also decreased significantly for the VOIs defined in the lungs when using the SAP approach. The differences between SUV estimates were statistically significant in most regions except for the lungs where there was no proof of statistical difference for some VOIs (particularly the lower left lung). It is worth to mention that the maximum absolute SUV error observed in the lung region was 0.2. Attenuation correction using the 3-class technique exhibited an average positive bias (mean relative absolute error) in the lungs of 18.0% (21.7%) compared to -0.27% (8.0%) when using our SAP approach. The uniform lung attenuation 25 coefficient of 0.022 cm-1 (770 HU) utilized on the Ingenuity TF PET/MRI seems to overcorrect the activity uptake. Ouyang et al. (Ouyang et al., 2013) also observed a positive uptake bias in the lungs for the 3-class attenuation map (5.8Â±14.6%). The clinical study used to evaluate the correlation between lung volume and corresponding attenuation coefficients (figure 4) demonstrated a wide range of volume and density changes among subjects. Since patients were chosen randomly and CT scans likely acquired at slightly different respiratory phases, the wide range of lung volumes can be attributed to either natural lung volume discrepancy among patients or different phase of the breathing cycle. Human lung volume and weight vary drastically across subjects depending on body height, altitude where they live and degree of obesity (actually ranging from 370 to 1.852 g and 1 to 8 litres, respectively) (Jones and Nzekwu, 2006; Marieb and Hoehn, 2007; Molina and DiMaio, 2012). The results shown in figure 4 were not used in the learning process since the lung volumes were calculated by segmenting CT images (not MR Dixon images). Conversely, the lung mask used in the learning process was obtained by segmenting in-phase MR images with the same settings and parameters. Segmentation-based lung volume estimation is sensitive to the MR sequence used and the produced contrast and quality as well as the segmentation technique used. In particular cases where the MR image contrast and segmentation technique allow including the vascular tree and the boundary of peripheric structures, such as the heart (because of partial volume effect), the measured lung volume is expected to be larger. Therefore, the pre-processing utilities and segmentation protocol must be kept constant to avoid erroneous prediction. The correlation between segmented lung volumes using CT and MR images was carefully checked during the adjustment of segmentation parameters. The mean relative difference between lung volumes obtained from segmenting MR and CT images is -1.17Â±3.8% whereas the absolute mean relative difference is 3.39Â±1.7% over the 14 patients. In figure 8, an attenuation coefficient of 0.022 cm-1 (770 HU) was assigned to the lesion in the 3-class attenuation map, whereas its average attenuation coefficient as estimated on the corresponding CT image is 0.0976 cm-1 (34 HU). The factors hampering the identification of these lesions include their low intensity on the MR image, limitations of segmentation techniques used, and size and position of lesions. The consequence is a significant underestimation of the tracer uptake in PET-MRAC3c (SUVmean of 6.1) compared to 7.8 estimated after correcting the 3-class attenuation map and 9.7 obtained from PET-CTAC. This method was used because of its simplicity but other sophisticated PET segmentation approaches which might have better performance can be used in this context (Abdoli et al., 2013). The application of this approach was restricted to the lung region where the corresponding density is assumed to be known a priori and equivalent to soft-tissue. The same methodology could be extended to lesions located in different regions provided they can be accurately delineated. 26 In the case of existing connectivity between void areas inside the body caused by metallic artefacts and surrounding background air, it is very likely that the segmentation procedure fails to differentiate the inner body area from background air which leads to large misclassifications. Bezrukov et al. proposed an automated technique for susceptibility artefact correction enabling to assign proper attenuation coefficients to metal induced void regions (Bezrukov et al., 2013b). Time-of-flight (TOF) PET image reconstruction has also been shown to substantially reduce the impact of metallic artefacts (Mehranian and Zaidi, 2015b). Figure 10C shows a representative clinical study presenting with metallic artefact where soft-tissue and the metallic implant in the patient shoulder have been misclassified as background air in the 3-class attenuation map. Since both SAP and Hofmannâ€™s approaches rely on information provided by the co-registered atlas dataset, they are less affected by metallic artefacts since void regions corresponding to the implant are usually filled with matching bony structures in the co-registered atlas. Moreover, using the k-nearest neighbour method in the SAP technique helps to pool the information from nearby textures to void areas to determine the most similar patient in the atlas dataset. The method proposed in this work differs from that of (Burgos et al., 2014) in the sense that two different similarity measures are used and exploited for different purposes. The LNCC process exhibits local fluctuation and susceptibility to noise when it comes to local similarity measure. However, it shows suitable performance to detect misalignment at a relatively larger scale (large patch of images). Therefore, in contrast to Burgosâ€™ approach, the LNCC is not used to generate weighting factors for atlas fusion; instead it is used to exclude atlas images exhibiting misalignment errors within large patches of the image. For this reason, a relatively large window was used for the LNCC processing, ensuring a robust similarity measure. In essence, the LNCC is used for coarse atlas refinement and sieving while the GPR kernel is used for local matching. The GPR kernel inherently contains a similarity measure based on intensity difference between patches of voxels within the image. The GPR kernel (Eqs. 1 or 3) acts very locally, in contrast to LNCC similarity measure, as there is a position-dependent term which decays exponentially as a function of the patch position. As such, this similarity measure is computed very locally (considering a patch size of 9Ã—9 voxels with a voxel size of 1 mm). As such, the GPR kernel alone may be unable to identify similar anatomy between target and atlas images due to insufficient local information. The major improvement achieved by the proposed method can be attributed to the semi-local atlas sorting step achieved by the LNCC step (supplemental figure 2). Conversely, clustering the MR images turned out to have a minor contribution compared to the atlas sorting step (supplemental figure 3), while rendering the algorithm more robust to inter-patient intensity non-uniformity. Registration errors and anatomical differences across patients are the major challenges in atlas-based methods. Despite the improvement brought by the proposed method, slight imperfections can still be seen in some cases (figure 10E), particularly in the shoulders and head and neck areas. Further 27 investigation is underway to minimize such errors by improving the accuracy of the registration algorithm and exploiting advanced pattern recognition techniques. Future work will focus on further improvement of bone extraction accuracy through optimization of atlas fusion and reduction of the computational time needed for atlas registration through alignment of multiple atlas images using a single registration to make the technique practical for clinical use. 5. Conclusion We proposed a new whole-body pseudo-CT generation approach exploiting the concept of co-registered atlas and pattern recognition. The SAP technique improved bone extraction leading to more accurate SUV estimation, particularly in bony structures and lung regions even in the presence of malignant abnormalities. Acknowledgments This work was supported by the Swiss National Science Foundation under grant SNFN 31003A-149957. 28    References Abdoli, M., Dierckx, R.A.J.O., Zaidi, H., 2013. Contourlet-based active contour model for PET image segmentation. Med Phys 40, 082507-082512. Akbarzadeh, A., Gutierrez, D., Baskin, A., Ay, M.R., Ahmadian, A., Riahi Alam, N., Lovblad, K., Zaidi, H., 2013. Evaluation of whole-body MR to CT deformable image registration. J Appl Clin Med Phys 14, 238-253. Altman, N.S., 1992. An introduction to kernel and nearest-neighbor nonparametric regression. The American Statistician 46, 175-185. Arabi, H., Rager, O., Alem, A., Varoquaux, A., Becker, M., Zaidi, H., 2015. Clinical assessment of MR-guided 3-class and 4-class attenuation correction in PET/MR. Mol Imaging Biol 17, 264-276. Ay, M.R., Akbarzadeh, A., Ahmadian, A., Zaidi, H., 2014. Classification of bones from MR images in torso PET-MR imaging using a statistical shape model. Nucl Instrum Meth A 734, Part B, 196-200. Berker, Y., Salomon, A., Kiessling, F., Schulz, V., 2012. Lung attenuation coefficient estimation using Maximum Likelihood reconstruction of attenuation and activity for PET/MR attenuation correction, IEEE Nuclear Science Symposium and Medical Imaging Conference (NSS/MIC), pp. 2282-2284. Bezrukov, I., Mantlik, F., Schmidt, H., Scholkopf, B., Pichler, B.J., 2013a. MR-based PET attenuation correction for PET/MR imaging. Semin Nucl Med 43, 45-59. Bezrukov, I., Schmidt, H., Mantlik, F., Schwenzer, N., Brendle, C., SchÃ¶lkopf, B., Pichler, B.J., 2013b. MR-based attenuation correction methods for improved PET quantification in lesions within bone and susceptibility artifact regions. J Nucl 54, 1768-1774. Burgos, N., Cardoso, M., Thielemans, K., Modat, M., Schott, J., Duncan, J., Atkinson, D., Arridge, S., Hutton, B., Ourselin, S., 2014. Attenuation correction synthesis for hybrid PET-MR scanners: Application to brain studies. IEEE Trans Med Imaging 33, 2332-2341. Cachier, P., Bardinet, E., Dormont, D., Pennec, X., Ayache, N., 2003. Iconic feature based nonrigid registration: the PASHA algorithm. Comp Vis Image Underst 89, 272-298. Chen, G.H., Yao, Z.F., Fan, X.W., Zhang, Y.J., Gao, H.Q., Qian, W., Wu, K.L., Jiang, G.L., 2013. Variation in background intensity affects PET-based gross tumor volume delineation in non-small-cell lung cancer: the need for individualized information. Radiother Oncol 109, 71-76. Collins, D.L., Pruessner, J.C., 2010. Towards accurate, automatic segmentation of the hippocampus and amygdala from MRI by augmenting ANIMAL with a template library and label fusion. Neuroimage 52, 1355-1366. Crum, W.R., Camara, O., Hill, D.L., 2006. Generalized overlap measures for evaluation and validation in medical image analysis. IEEE Trans Med Imaging 25, 1451-1461. Danielsson, P.-E., 1980. Euclidean distance mapping. Computer Graphics and image processing 14, 227-248. Defrise, M., Rezaei, A., Nuyts, J., 2012. Time-of-flight PET data determine the attenuation sinogram up to a constant. Phys Med Biol 57, 885-899. Delso, G., Wiesinger, F., Sacolick, L., Kaushik, S., Shanbhag, D., Hullner, M., Veit-Haibach, P., 2015. Clinical evaluation of zero echo time MRI for the segmentation of the skull. J Nucl Med 56, 417-422. Dice, L.R., 1945. Measures of the amount of ecologic association between species. Ecology 26, 297-302. Disselhorst, J.A., Bezrukov, I., Kolb, A., Parl, C., Pichler, B.J., 2014. Principles of PET/MR Imaging. J Nucl Med 55, 2S-10S. Dixon, W.T., 1984. Simple proton spectroscopic imaging. Radiology 153, 189-194. Ebden, M., 2008. Gaussian processes for regression: A quick introduction. The Website of Robotics Research Group in Department on Engineering Science, University of Oxford. Gerig, G., Jomier, M., Chakos, M., 2001. Valmet: A new validation tool for assessing and improving 3D object segmentation, Proceedings of the 4th International Conference on Medical Image Computing and Computer-Assisted Intervention. Springer-Verlag, pp. 516-523. 29  Heimann, T., van Ginneken, B., Styner, M.A., Arzhaeva, Y., Aurich, V., Bauer, C., Beck, A., Becker, C., Beichel, R., Bekes, G., Bello, F., Binnig, G., Bischof, H., Bornik, A., Cashman, P.M., Chi, Y., Cordova, A., Dawant, B.M., Fidrich, M., Furst, J.D., Furukawa, D., Grenacher, L., Hornegger, J., Kainmuller, D., Kitney, R.I., Kobatake, H., Lamecker, H., Lange, T., Lee, J., Lennon, B., Li, R., Li, S., Meinzer, H.P., Nemeth, G., Raicu, D.S., Rau, A.M., van Rikxoort, E.M., Rousson, M., Rusko, L., Saddi, K.A., Schmidt, G., Seghers, D., Shimizu, A., Slagmolen, P., Sorantin, E., Soza, G., Susomboon, R., Waite, J.M., Wimmer, A., Wolf, I., 2009. Comparison and evaluation of methods for liver segmentation from CT datasets. IEEE Trans Med Imaging 28, 1251-1265. Hofmann, M., Bezrukov, I., Mantlik, F., Aschoff, P., Steinke, F., Beyer, T., Pichler, B.J., Scholkopf, B., 2011. MRI-based attenuation correction for whole-body PET/MRI: Quantitative evaluation of segmentation- and Atlas-based methods. J Nucl Med 52, 1392-1399. Hofmann, M., Steinke, F., Scheel, V., Charpiat, G., Farquhar, J., Aschoff, P., Brady, M., Scholkopf, B., Pichler, B.J., 2008. MRI-based attenuation correction for PET/MRI: A novel approach combining pattern recognition and Atlas registration. J Nucl Med 49, 1875-1883. Izquierdo-Garcia, D., Sawiak, S.J., Knesaurek, K., Narula, J., Fuster, V., Machac, J., Fayad, Z.A., 2014. Comparison of MR-based attenuation correction and CT-based attenuation correction of whole-body PET/MR imaging. Eur J Nucl Med Mol Imaging 41, 1574-1584. Johansson, A., Karlsson, M., Nyholm, T., 2011. CT substitute derived from MRI sequences with ultrashort echo time. Med Phys 38, 2708-2714. Jones, R.L., Nzekwu, M.-M.U., 2006. The effects of body mass index on lung volumes. Chest journal 130, 827-833. Kapanen, M., Tenhunen, M., 2013. T1/T2*-weighted MRI provides clinically relevant pseudo-CT density data for the pelvic bones in MRI-only based radiotherapy treatment planning. Acta Oncologica 52, 612-618. Kass, M., Witkin, A., Terzopoulos, D., 1988. Snakes: active contour models. Int J Comput Vision 1, 321-331. Keereman, V., Fierens, Y., Broux, T., De Deene, Y., Lonneux, M., Vandenberghe, S., 2010. MRI-based attenuation correction for PET/MRI using ultrashort echo time sequences. J Nucl Med 51, 812-818. Kim, J.H., Lee, J.S., Song, I.C., Lee, D.S., 2012. Comparison of segmentation-based attenuation correction methods for PET/MRI: Evaluation of bone and liver standardized uptake value with oncologic PET/CT data. J Nucl Med 53, 1878-1882. Klein, A., Andersson, J., Ardekani, B.A., Ashburner, J., Avants, B., Chiang, M.-C., Christensen, G.E., Collins, D.L., Gee, J., Hellier, P., 2009. Evaluation of 14 nonlinear deformation algorithms applied to human brain MRI registration. Neuroimage 46, 786-802. Lonn, A.R., Wollenweber, S.D., 2012. Estimation of mean lung attenuation for use in generating PET attenuation maps, IEEE Nuclear Science Symposium and Medical Imaging Conference (NSS/MIC), pp. 3017-3018. Lotjonen, J.M., Wolz, R., Koikkalainen, J.R., Thurfjell, L., Waldemar, G., Soininen, H., Rueckert, D., Alzheimer's Disease Neuroimaging, I., 2010. Fast and robust multi-atlas segmentation of brain magnetic resonance images. Neuroimage 49, 2352-2365. Marieb, E.N., Hoehn, K., 2007. Human anatomy & physiology. Pearson Education. Marshall, H.R., Patrick, J., Laidley, D., Prato, F.S., Butler, J., Theberge, J., Thompson, R.T., Stodilka, R.Z., 2013. Description and assessment of a registration-based approach to include bones for attenuation correction of whole-body PET/MRI. Med Phys 40, 082509. Marshall, H.R., Prato, F.S., Deans, L., Theberge, J., Thompson, R.T., Stodilka, R.Z., 2012. Variable lung density consideration in attenuation correction of whole-body PET/MRI. J Nucl Med 53, 977-984. Martinez-Moller, A., Souvatzoglou, M., Delso, G., Bundschuh, R.A., Chefd'hotel, C., Ziegler, S.I., Navab, N., Schwaiger, M., Nekolla, S.G., 2009. Tissue classification as a potential approach for attenuation correction in whole-body PET/MRI: Evaluation with PET/CT data. J Nucl Med 50, 520-526. 30 McAuliffe, M.J., Lalonde, F.M., McGarry, D., Gandler, W., Csaky, K., Trus, B.L., 2001. Medical Image Processing, Analysis and Visualization in clinical research, Proceedings 14th IEEE Symposium on Computer-Based Medical Systems, 2001. CBMS 2001, pp. 381-386. Mehranian, A., Zaidi, H., 2015a. Emission-based estimation of lung attenuation coefficients for attenuation correction in time-of-flight PET/MR. Phys Med Biol 60, 4813-4833. Mehranian, A., Zaidi, H., 2015b. Impact of time-of-flight PET on quantification errors in MR imaging-based attenuation correction. J Nucl Med 56, 635-641. Mehranian, A., Zaidi, H., 2015c. Joint estimation of activity and attenuation in whole-body TOF PET/MRI using constrained Gaussian mixture models. IEEE Trans Med Imaging 34, 1808-1821. Molina, D.K., DiMaio, V.J.M., 2012. Normal Organ Weights in Men: Part IIâ€”The Brain, Lungs, Liver, Spleen, and Kidneys. Am J Forensic Med Pathol 33, 368-372. Murphy, K., Van Ginneken, B., Reinhardt, J.M., Kabus, S., Ding, K., Deng, X., Cao, K., Du, K., Christensen, G.E., Garcia, V., 2011. Evaluation of registration methods on thoracic CT: the EMPIRE10 challenge. IEEE Trans Med Imaging 30, 1901-1920. NyÃºl, L.G., Udupa, J.K., Zhang, X., 2000. New variants of a method of MRI scale standardization. IEEE Trans Med Imaging 19, 143-150. Ouyang, J., Chun, S.Y., Petibon, Y., Bonab, A.A., Alpert, N., El Fakhri, G., 2013. Bias atlases for segmentation-based PET attenuation correction using PET-CT and MR. IEEE Trans Nuc Sci 60, 3373-3382. Panin, V.Y., Kehren, F., Hamill, J.J., Michel, C., 2004. Application of discrete data consistency conditions for selecting regularization parameters in PET attenuation map reconstruction. Phys Med Biol 49, 2425-2436. Robitaille, N., Mouiha, A., CrÃ©peault, B., Valdivia, F., Duchesne, S., 2012. Tissue-based MRI intensity standardization: application to multicentric datasets. Journal of Biomedical Imaging 2012, 347120. Rosenblum, L.J., Mauceri, R.A., Wellenstein, D.E., Thomas, F.D., Bassano, D.A., Raasch, B.N., Chamberlain, C.C., Heitzman, E.R., 1980. Density patterns in the normal lung as determined by computed tomography. Radiology 137, 409-416. Rosenfeld, A., Kak, A.C., 1982. Digital Picture Processing: Vol.: 1. Academic Press, Incorporated. Schramm, G., Langner, J., Hofheinz, F., Petr, J., Beuthien-Baumann, B., Platzek, I., Steinbach, J., Kotzerke, J., Hoff, J., 2013. Quantitative accuracy of attenuation correction in the Philips Ingenuity TF whole-body PET/MR system: a direct comparison with transmission-based attenuation correction. Magn Reson Mat Phys Biol Med 26, 115-126. Schulz, V., Torres-Espallardo, I., Renisch, S., Hu, Z., Ojha, N., BÃ¶rnert, P., Perkuhn, M., Niendorf, T., SchÃ¤fer, W., Brockmann, H., Krohn, T., Buhl, A., GÃ¼nther, R., Mottaghy, F., Krombach, G., 2011. Automatic, three-segment, MR-based attenuation correction for whole-body PET/MR data. Eur J Nucl Med Mol Imaging 38, 138-152. Soejima, K., Yamaguchi, K., Kohda, E., Takeshita, K., Ito, Y., Mastubara, H., Oguma, T., Inoue, T., Okubo, Y., Amakawa, K., Tateno, H., Shiomi, T., 2000. Longitudinal follow-up study of smoking-induced lung density changes by high-resolution computed tomography. Am J Respir Crit Care Med 161, 1264-1273. Tong, Y., Udupa, J.K., Odhner, D., Sharma, S., Torigian, D.A., 2015. Interactive non-uniformity correction and intensity standardization of MR images, SPIE Medical Imaging. International Society for Optics and Photonics, pp. 94151N-94156. Torigian, D.A., Zaidi, H., Kwee, T.C., Saboury, B., Udupa, J.K., Cho, Z.-H., Alavi, A., 2013. PET/MR Imaging: Technical aspects and potential clinical applications. Radiology 267, 26-44. Tustison, N.J., Avants, B.B., Cook, P.A., Zheng, Y., Egan, A., Yushkevich, P.A., Gee, J.C., 2010. N4ITK: improved N3 bias correction. IEEE Trans Med Imaging 29, 1310-1320. Varoquaux, A., Rager, O., Poncet, A., Delattre, B.M., Ratib, O., Becker, C.D., Dulguerov, P., Dulguerov, N., Zaidi, H., Becker, M., 2014. Detection and quantification of focal uptake in head and neck tumours: (18)F-FDG PET/MR versus PET/CT. Eur J Nucl Med Mol Imaging 41, 462-475. 31 Wahl, R.L., Jacene, H., Kasamon, Y., Lodge, M.A., 2009. From RECIST to PERCIST: Evolving considerations for PET response criteria in solid tumors. J Nucl Med 50, 122S-150. Weickert, J., 1998. Anisotropic diffusion in image processing. Teubner Stuttgart. Wollenweber, S.D., Ambwani, S., Delso, G., Lonn, A.H.R., Mullick, R., Wiesinger, F., Piti, Z., Tari, A., Novak, G., Fidrich, M., 2013. Evaluation of an atlas-based PET head attenuation correction using PET/CT & MR patient data. IEEE Trans Nucl Sci 60, 3383-3390. Xia, Y., Fripp, J., Chandra, S.S., Schwarz, R., Engstrom, C., Crozier, S., 2013. Automated bone segmentation from large field of view 3D MR images of the hip joint. Phys Med Biol 58, 7375-7390. Yoo, T.S., Ackerman, M.J., Lorensen, W.E., Schroeder, W., Chalana, V., Aylward, S., Metaxas, D., Whitaker, R., 2002. Engineering and algorithm design for an image processing Api: a technical report on ITK-the Insight Toolkit. Stud Health Technol Inform 85, 586-592. Yushkevich, P.A., Piven, J., Hazlett, H.C., Smith, R.G., Ho, S., Gee, J.C., Gerig, G., 2006. User-guided 3D active contour segmentation of anatomical structures: significantly improved efficiency and reliability. Neuroimage 31, 1116-1128. Yushkevich, P.A., Wang, H., Pluta, J., Das, S.R., Craige, C., Avants, B.B., Weiner, M.W., Mueller, S., 2010. Nearly automatic segmentation of hippocampal subfields in in vivo focal T2-weighted MRI. Neuroimage 53, 1208-1224. Zaidi, H., Del Guerra, A., 2011. An outlook on future design of hybrid PET/MRI systems. Med Phys 38, 5667-5689. Zaidi, H., Hasegawa, B.H., 2003. Determination of the attenuation map in emission tomography. J Nucl Med 44, 291-315. Zaidi, H., Montandon, M.-L., Slosman, D.O., 2003. Magnetic resonance imaging-guided attenuation and scatter corrections in three-dimensional brain positron emission tomography. Med Phys 30, 937-948. Zaidi, H., Ojha, N., Morich, M., Griesmer, J., Hu, Z., Maniawski, P., Ratib, O., Izquierdo-Garcia, D., Fayad, Z.A., Shao, L., 2011. Design and performance evaluation of a whole-body Ingenuity TF PET-MRI system. Phys Med Biol 56, 3091-3106. Zhuge, Y., Udupa, J.K., Liu, J., Saha, P.K., 2009. Image background inhomogeneity correction in MRI via intensity standardization. Computerized Medical Imaging and Graphics 33, 7-16. 32   