NIH Public AccessAuthor ManuscriptMed Image Anal. Author manuscript; available in PMC 2008 June 1.Published in final edited form as:Med Image Anal. 2007 June ; 11(3): 207–223.Direct Cortical Mapping via Solving Partial Differential Equationson Implicit SurfacesI-NHPAAuthorManuscriptYonggang Shia, Paul M. Thompsona, Ivo Dinova, Stanley Osherb, and Arthur W. Togaa,*aLaboratory of Neuro Imaging, Department of Neurology, UCLA School of Medicine, Los Angeles, CA 90095,USAbMathematics Department, UCLA, Los Angeles, CA 90095, USAI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptAbstractIn this paper, we propose a novel approach for cortical mapping that computes a direct map betweentwo cortical surfaces while satisfying constraints on sulcal landmark curves. By computing the mapdirectly, we can avoid conventional intermediate parameterizations and help simplify the corticalmapping process. The direct map in our method is formulated as the minimizer of a flexiblevariational energy under landmark constraints. The energy can include both a harmonic term to ensuresmoothness of the map and general data terms for the matching of geometric features. Starting froma properly designed initial map, we compute the map iteratively by solving a partial differentialequation (PDE) defined on the source cortical surface. For numerical implementation, a set ofadaptive numerical schemes are developed to extend the technique of solving PDEs on implicitsurfaces such that landmark constraints are enforced. In our experiments, we show the flexibility ofthe direct mapping approach by computing smooth maps following landmark constraints from twodifferent energies. We also quantitatively compare the metric preserving property of the directmapping method with a parametric mapping method on a group of 30 subjects. Finally, wedemonstrate the direct mapping method in the brain mapping applications of atlas construction andvariability analysis.KeywordsBrain mapping; cortex; atlas; direct mapping; harmonic mapping; level-set; PDEs1 IntroductionThe cerebral cortex is a convoluted sheet of gray matter in the brain that contains many distinctareas controlling various neural functions. The size, shape, and relative locations of these areascan be affected profoundly by many normal and pathological processes. The analysis of thecorrelation between such structural changes and the correspondingly affected functions on thecortex is a fundamental problem in brain mapping (Welker, 1990). For such studies, corticalmapping is an important tool that can provide a detailed comparison of correspondingfunctional and anatomical regions on different cortices. A detailed map for a group of corticesforms the foundation for further statistical analyses of associated properties such as gray matter* Laboratory of Neuro Imaging, Department of Neurology, UCLA School of Medicine, Los Angeles, CA 90095, USA Email address:toga@loni.ucla.edu (Arthur W. Toga)..Publisher's Disclaimer: This is a PDF file of an unedited manuscript that has been accepted for publication. As a service to our customerswe are providing this early version of the manuscript. The manuscript will undergo copyediting, typesetting, and review of the resultingproof before it is published in its final citable form. Please note that during the production process errors may be discovered which couldaffect the content, and all legal disclaimers that apply to the journal pertain.   I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptShi et al.Page 2thickness growth or decay at specific locations on the cortex. Mapping a group of cortices toa cortical atlas also provides a valuable platform for the visualization and analysis ofexperimental data collected from group members.Due to the convoluted nature and variability among different brains, mapping of the corticalsurfaces poses many numerical challenges for classical surface matching algorithms such asthe iterative closest point(ICP) method (Besl and McKay, 1992) and its extension in brainmapping (Wang et al., 2000). Thus, the cortical mapping problem is conventionally solvedthrough an indirect approach as illustrated in Fig. 1. A core step in this indirect approach is theparameterization of the cortical surface that assigns a 2D coordinate to each point on thesurface. Popular parameterization choices include the flat 2D plane and sphere. Considerablework has been done in this area (Schwartz and Merker, 1986; Schwartz et al., 1989; Carmanet al., 1995; Drury et al., 1996; Sereno et al., 1996; Thompson and Toga, 1996; Hurdal et al.,1999; Hurdal and Stephenson, 2004; Angenent et al., 1999; Fischl et al., 1999a; Timsari andLeahy., 2000; Grossman et al., 2002; Gu et al., 2004; Tosun et al., 2004; Tosun and Prince,2005; Ju et al., 2004; Joshi et al., 2004; Wang et al., 2005b; Van Essen, 2005). The work in(Clouchoux et al., 2005) also proposed to construct a spherical coordinate system directly onthe cortical surface. In order to map a cortical surface to a flat plane, artificial cuts have to beintroduced carefully to open the surface (Fischl et al., 1999a). Instead, the mapping of thecortical surface to a sphere maintains the original topology and can be automated completely.Anatomical features from two different cortices however may not be parameterized with thesame coordinates. To establish the final correspondences from the source cortex to the targetcortex, a warping process needs to be applied in the parameterization domain underanatomically meaningful constraints. Thanks to the parameterization step, this warping processcan be computed using algorithms developed in nonlinear image registration (Christensen etal., 1996; Davatzikos et al., 1996; Dupuis et al., 1998; Grenander and Miller, 1998; Toga,1998; Joshi and Miller, 2000; Thompson et al., 2000a,b; Toga and Thompson, 2003a,b;Thompson et al., 2004; Avants and Gee, 2004). In terms of anatomical constraints in thewarping process, one of the most popular choices is to constrain the map to match sulcal andgyral landmarks on both cortical surfaces (Van Essen et al., 1998; Glaunes et al., 2004;Thompson et al., 2000a,b, 2004). It is interesting to point out that sulcal landmarks were alsoused in many nonlinear image registration algorithms (Collins et al., 1998; Cachier et al.,2001; Hellier and Barillot, 2003). One can also apply curvature related geometric propertiesof the cortical surface to guide the mapping procedure (Fischl et al., 1999b; Tosun and Prince,2005). To establish the final cortex to cortex map, the map computed in the warping processcan be pulled back to both the source and target cortical surfaces using the parameterization.In this paper, we propose a novel and PDE-based approach to compute a direct map from thesource to the target cortical surface that follows constraints on sulcal landmark curves. Bycomputing the map directly, we can simplify the whole mapping process and potentially helpreduce numerical artifacts in the intermediate parameterization steps. Our work is built uponthe implicit harmonic mapping method proposed in (Bertalmío et al., 2001; Mémoli et al.,2004a), which computes a map between two surfaces by iteratively solving a PDE derivedfrom the Euler-Lagrange equation of the harmonic energy. A key step in this implicit mappingmethod, which is defined on the source surface, is to represent both the source and targetsurfaces as the zero level set of functions (Osher and Sethian, 1988), which enables thecalculation of intrinsic gradients on the surfaces using well understood numerical schemes onregular Cartesian grids. The work in (Mémoli et al., 2004a), however, mainly concerns withmapping between general manifolds and no landmark constraints are considered, which iscritical for our problem. The direct cortical mapping algorithm we develop here extends thework of (Mémoli et al., 2004a) in several ways. First of all, we develop a general approach toincorporate boundary conditions into implicit mapping methods. To achieve that, we constructMed Image Anal. Author manuscript; available in PMC 2008 June 1.   I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptShi et al.Page 3a triangular mesh representation of the boundary condition defined on landmark curves. Thismakes the information of the boundary condition easily accessible on the Cartesian grid andleads us to design a set of adaptive numerical schemes to solve the PDE derived from the Euler-Lagrange equation of the harmonic energy. This enables our algorithm to minimize theharmonic energy while respecting the boundary condition. Another important element of ouralgorithm is a novel approach to finding an initial map between two cortical surfaces using anew feature called landmark context we develop here. This provides a reasonably good startingpoint for our iterative algorithm. Besides landmark constraints, we have also extended theharmonic energy with general data terms that are valuable in matching geometric features, suchas the mean curvature, of the source and target cortical surface.Recently an important result from (Mémoli et al., 2006) also considered incorporatingboundary conditions into the direct mapping process. They formulated the boundary conditionas defined on a set of discrete points and proposed to compute the map by minimizing its globalLipschitz constant. In contrast to the implicit approach, this method is not based on solvingPDEs and finds the map using a search strategy with the aim of minimizing the Lipschitzconstant. This is, in principle, a very general method, but sulcal landmarks were not tested in(Mémoli et al., 2006), so its application in cortical mapping still needs to be further studied.In the rest of the paper, we first review the mathematical background of solving PDEs onimplicit surfaces in section 2. We then propose a general variational framework for directmapping in section 3 and extend the technique reviewed in section 2 to incorporate boundaryconditions defined on landmark curves. In section 4, we develop a front propagation typemethod to construct initial maps based on a new feature landmark context. This provides agood starting point for our iterative algorithm. An extension of the variational energy to includegeneral data terms is proposed in section 5. Experimental results are presented in section 6 todemonstrate our direct mapping method. Finally, conclusions are made in section 7.2 PDEs on Implicit SurfacesThe idea of using implicit level-set representations to solve PDEs on manifolds was firstintroduced in (Bertalmío et al., 2001). Since our current focus is cortical mapping, we limitour discussion to surfaces embedded in R3, but the general idea of solving PDEs on implicitmanifolds is applicable to arbitrary dimensions.Let ℳ denote a surface and a level-set function ϕ: R3 → R be its implicit representation suchthat ℳ is the zero level set of ϕ. Though there are no particular requirement on the level-setfunction ϕ, we choose ϕ as the signed distance function of ℳ. This is a desirable choice sinceit can greatly simplify many of our mathematical derivations using the property that ∣∇ϕ∣ = 1for a signed distance function.To present the idea of PDEs on implicit surfaces, we use the heat diffusion equation as anexample:∂u∂t= ΔMu(1)where u: M → R is a function defined on the surface, and ΔM is the Laplace-Beltrami operatoron ℳ, which is the intrinsic counterpart on the manifold of the Laplacian operator in Euclideanspace. From a variational point of view, the equation in (1) is the flow that minimizes theharmonic energy function E defined on ℳ:E =∫M ∣ ∇Mu∣ 2dM(2)Med Image Anal. Author manuscript; available in PMC 2008 June 1.   I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptShi et al.Page 4where ∇Mu is the intrinsic gradient of u on ℳ.One of the major advantages of using the level-set representation is that all computations areperformed on Cartesian grids with easy to implement numerical schemes. Besides representingthe surface ℳ implicitly with a signed distance function defined on a regular grid, we also needto extend the function u off the surface to the grid so that all computations can be doneimplicitly. Since we only care about the solution of u on the surface, it is only necessary toextend u to a tubular narrow band around ℳ as we illustrate in Fig. 2. Typically we extend uto this narrow band such that ∇u · ∇ϕ = 0, i.e., u is constant along the normal direction of ℳ.Numerically this can be achieved by using the fast marching method (Tsitsiklis, 1995;Sethian,1996) or solving the following PDE in the narrow band as proposed in (Chen et al., 1997):∂u∂t+ ∇u⋅ ∇ϕ= 0.(3)After extending u to the narrow band, we can transform the energy function on ℳ into anintegral over the Euclidean space. First we can represent the intrinsic gradient of u on ℳ usingits implicit representation as:∇Mu= ∏∇ϕ∇uwhere ∏∇ϕ is a projection operator defined as:T∏∇ϕ = I − ∇ϕ∇ϕ.(4)(5)Here I is the identity operator and ∇ϕ is the normal vector of ℳ using the fact that ϕ is thesigned distance function of ℳ. When we apply ∏∇ϕ to the regular gradient of u in Euclideanspace, it projects ∇u onto the tangent space of ℳ. Using this projection operator, the harmonicenergy in (2) can be translated into an integral over the whole Euclidean space in terms of thelevel-set function ϕ as:E =∫∣ ∏∇ϕ∇u∣ 2δ(ϕ)dx.(6)We can then compute the first variation of the energy with respect to u and derive the gradientdescent flow of u as in (Bertalmío et al., 2001):∂u∂t= ∇ ⋅ (∏∇ϕ∇u).(7)This is the implicit form of the PDE in (1). Compared with techniques that solve the PDEexplicitly on the surface, the implicit form enables us to perform all computations on theCartesian grid and apply standard numerical schemes with well understood error measures.Since the computations are only done in a narrow band of the surface, the computational costis on the same order as methods using explicit representations.Besides the heat diffusion equation, a solution of fourth order PDEs on implicit surfaces isdeveloped in (Greer et al., 2005). Also a modified projection operator for the diffusion equationis proposed in (Greer, 2005) to replace the procedure of reinitialization that extends the functionu off the surface periodically. Finite element schemes are also proposed in (Burger, 2005) forthe solution of PDEs on implicitly represented surfaces. Closely related to the level-setapproach, a phase-field method of solving PDEs on implicit surfaces is proposed in (Ratz andVoigt, 2005).Med Image Anal. Author manuscript; available in PMC 2008 June 1.   Shi et al.Page 5The idea of solving PDEs on implicit surfaces is generalized to the mapping between manifolds,in (Mémoli et al., 2004a,b). Assume we have a source manifold ℳ and a target manifold the goal in (Mémoli et al., 2004a,b) is to compute a vector function u : M → N that minimizesthe harmonic energy function. Following the work in (Bertalmío et al., 2001), the source andtarget manifold are represented implicitly and we denote ϕ and ψ as the signed distance function, respectively. Similar to the case of scalar functions on the surface, we also extendof ℳ and the vector map u off the surface ℳ to a narrow band around it. Using the implicitrepresentations, we can write the harmonic energy of the mapping from ℳ to as:E =∫122ϕ∥ J∥uδ(ϕ)dx.(8)This is also an energy defined over the Euclidean space about the map u. The intrinsic Jacobianϕ in the energy is defined as:JuϕJu= Ju∏∇ϕ(9)with Ju denoting the regular Jacobian of function in R3. The matrix norm in (8) is the Frobenius2 . To minimize energy function, we can derive the firstnorm defined as ∥ Juvariation of the energy with respect to the map u and obtain the gradient descent flow of u as:ϕ ∥ 2 = ∑ij(Juϕ)ij∂ u∂tT= ∏∇ψ(u(x,t)) (∇ .(∏∇ϕJu))(10)where Π∇ψ(u(x,t)) = I − ∇ψ (u(x, t))∇ψ (u(x, t))T is the projection operator onto the tangent spaceof at the point u(x, t). This projection operator reflects the constraints that u has to mapeach point on ℳ onto direction of . and thus the map is only updated iteratively along the tangentTo extend the work in (Mémoli et al., 2004a,b) and develop a direct cortical mapping strategy,there are two major challenges. The work to date on solving PDEs on implicit surfaces hasfocused on generic surfaces with no landmark constraints, but the constraints of sulcal landmarkcurves are very important in brain mapping and novel numerical schemes have to be developedto incorporate such constraints in computing the map. The second challenge results from theconstraints that the vector u has to be on the target manifold of the energy in (8) non-convex, which is easy to see since the linear combination of two. This makes the optimization is not necessarily a valid mapping. A close initialization has to bemappings from ℳ to found for this high dimensional (greater than 104) optimization problem in order for gradientdescent type algorithms to converge to the right solution. Interestingly these two challengesare closely related. It is indeed the sulcal curves in the first challenge that provide us a solutionto the second challenge. In the next two sections, we will address these two challenges andpresent our approach for direct cortical mapping.I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscript3 Direct Cortical Mapping With Sulcal LandmarksIn this section, we first propose our variational framework for cortical mapping with sulcallandmark constraints. We then develop a triangular mesh representation of the boundarycondition that extends the landmark curves, together with the constraints defined on them, intothe narrow band where we solve the mapping PDE. After that, adaptive numerical schemes onCartesian grids are developed to solve the PDE in (10) on the implicitly represented sourceMed Image Anal. Author manuscript; available in PMC 2008 June 1.   I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptShi et al.Page 6cortical surface while taking into account the boundary condition carried on their meshrepresentations.3.1 A Variational FrameworkLet ℳ denote the source cortical surface and denote the target cortical surface. Their signeddistance functions are denoted as ϕ and ψ, respectively. For both surfaces, a set of sulcal curvesk(k = 1, ⋯ , k)} be the set of sulcal curvesare delineated that will control the mapping. Let {CMk(k = 1, ⋯ , k)} the sulcal curves on on ℳ and {CNbetween the K pairs of curves (CMboundary conditions for the computation of the map. A simple approach to obtain such a mapis to parameterize each pair of curves with arc length and establish correspondences betweenpoints on the two curves by uniform sampling. One can also establish the mapping betweencurves using the method in (Leow et al., 2005).k)(k = 1, ⋯ , k) are known and they will provide the. In this work, we assume the mappingk, CNGiven the mapping between sulcal landmark curves on two cortical surfaces, we propose ageneral variational framework to compute a direct map u from the source surface ℳ to thetarget surface as follows:u = arg minE(u)uwith the boundary condition:ku(CMk) = CN(k = 1, ⋯, K).(11)(12)By solving this variational problem, we can obtain a smooth map from ℳ to the sulcal landmark constraints. that satisfiesWe first focus on the development of our direct cortical mapping algorithm with E as theharmonic energy defined in (8). The harmonic mapping between surfaces is a natural extensionof the concept of geodesics on surfaces, which are 1-D harmonic mappings. As the minimizerof the harmonic energy, the map interpolates as smooth as possible in areas between landmarkcurves and can help reduce metric distortions. The mathematics of harmonic mappings is alsovery well understood and can be found, for example, in the excellent reviews of (Eells andLemaire, 1995). The techniques we develop here for the incorporation of landmark constraints,however, are not limited to the harmonic energy and can be applied to other energies, forexample p-harmonic energies. This also connects our work to that of (Mémoli et al., 2006) aswe can compute a p-harmonic map to approximate the map that minimizes the Lipschitzextensions with p → ∞. Our direct mapping framework in (11) and (12) is flexible and it canalso include interesting data terms with the harmonic energy as a regularizer. After a completesolution for the minimization of the harmonic energy is developed, we extend it with a leastsquare data term in section 5 to demonstrate the flexibility of our method.To solve the energy minimization problem, we use an iterative strategy. Starting from an initialguess, we update the map iteratively toward the descent direction of the energy function whilemaintaining the constraints on landmark curves. This is achieved by treating the constraints in(12) as Dirichlet boundary conditions while solving the PDE in (10). Intuitively we can viewthis as a diffusion process of u on ℳ. By fixing the value of u over the landmark curves, weblock the flow of the heat across the landmark curves, but otherwise the heat can flow freelyto decrease the harmonic energy.Med Image Anal. Author manuscript; available in PMC 2008 June 1.   I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptShi et al.Page 7To realize the above idea numerically, we will first develop an algorithm to extend the boundarycondition of the map u on sulcal curves to the narrow band surrounding the source corticalsurface because this is where the map u and the level-set function ϕ are defined in the implicitapproach of solving PDEs on surfaces. The extension of the sulcal curves form surface patchesin the narrow band which we represent as triangular meshes. To take into account the boundarycondition carried on these meshes while solving the PDE in (10), adaptive numerical schemesare then developed to compute all the gradients of u on Cartesian grids.3.2 Mesh Representation of the Sulcal Landmark ConstraintsWe extend each sulcal curve of ℳ jointly with the constraints defined on it to a surface patchcrossing the surrounding narrow band of ℳ where its implicit representation ϕ is defined. Theresult of the extension is a triangular mesh representation of the boundary condition. Note thatimplicit representations for curves on surfaces were used in (Bertalmío et al., 1999; Burchardet al., 2001; Cheng et al., 2002; Leow et al., 2005) where a curve was represented as theintersection of multiple level-set functions. These methods are mainly designed for theevolution of curves and it could be memory and computationally expensive when the numberof 3D curves increases. For the set of static sulcal landmark curves in our problem, the meshrepresentation proposed here provides a compact and effcient way of accessing the boundaryconstraints.Let C denote a sulcal curve on ℳ and we extend the boundary condition u(C) on this curve offthe surface ℳ as follows. We first approximate the curve C and the boundary condition u(C)piecewise linearly by sampling the curve C uniformly into L points as p1, p2, ⋯ pL. For eachpoint pi(1 ≤ i ≤ L) and the boundary condition u(pi) at this point, we extend them off the normaldirection of the surface by constructing a piecewise linear curve consisting of line segmentsconnecting 2Q + 1 points p^i, j( − Q ≤ j ≤ Q)}. Each point on this curve will carry the samevalue for the map as u(pi). In constructing this curve, we start with p^i,0 = pi. We then extendi, j = p^pi outward of ℳ sequentially by defining p^i, j−1 + hni, j−1 for 1 ≤ j ≤ Q, where ni,j−1i, j−1 defined as ∇ϕ(p^is the normal direction at the point p^i, j−1) and h is the sampling intervalof the Cartesian grid where the implicit function ϕ is defined. Similarly we extend pi inwardsequentially by defining p^normal direction at the point p^curve will cross the narrow band, i.e., both p^i,−Q are outside the narrow band. Thiswill ensure the triangular mesh constructed next from these curves will also cross the narrowband. In practice, we choose Q = W + 2 if the narrow band is of width 2W h.i, j+1 − hni, j+1 for −Q ≤ j ≤ −1 with ni,j+1 denoting thei, j+1. The number Q is chosen bigger enough such that thisi,Q and p^i, j = p^i, j+1, p^i+1, j+1, p^Once we have all the curves emanating from the sampled points pi(1 ≤ i ≤ L) on the sulcalcurve C, we can construct the mesh representation of the boundary condition. The set of verticesof this mesh includes all the points p^i, j(1 ≤ i ≤ L , − Q ≤ j ≤ Q). The faces of the mesh arecomposed of triangles with vertices of the form (p^i, j, p^(p^i+1, j). We denote this triangular mesh as the extended surface of thelandmark curve C. As an example, we show such an extended surface constructed from alandmark curve in Fig. 3. Because the map u is defined on all the vertices, its value at anarbitrary point on the extended surface of C can be obtained using linear interpolation fromthe map values of the three vertices of the triangle to which it belongs. If we repeat the aboveprocedure for each sulcal curve of ℳ, we extend the complete set of landmark constraints tothe extended surfaces of these curves. Because these extended surfaces cross the narrow bandof ℳ by construction, each grid point in the narrow band can have access to this informationeasily as we show next.i, j+1, p^i+1, j) orMed Image Anal. Author manuscript; available in PMC 2008 June 1.   Shi et al.Page 83.3 Adaptive Numerical SchemesBefore we present our adaptive numerical schemes, we first define the notion of connectednessbetween neighboring grid points for the purpose of incorporating landmark constraints. Fortwo neighboring grid points x1 and x2, we call them connected if the line segment connectingx1 and x2 does not cross the extended surface of any landmark curve. In the derivation below,we will use integer indices such as (i, j, k) to denote points in the 3D Cartesian grid.In designing numerical schemes to solve (10) and taking into account the boundary conditions,our basic strategy is to prevent the numerical stencil used in computing partial gradients of ufrom crossing the extended surface of any landmark curve. This blocks the diffusion fromcrossing such surfaces in the narrow band of ℳ. Since only up to second order gradients areused in solving (10), we demonstrate below the first and second order adaptive numericalschemes that take into account the boundary conditions carried on the extended surfaces ofsulcal curves.Let the three components of the map u be denoted as u = [u1 u2 u3]. The forward differencescheme of the first order gradient of up(p = 1, 2, 3) at the point (i, j, k) is defined as:if (i, j, k) and (i+ 1, j, k) are connected,xD+upijkp − ui+1jkhpijk={ u∼upi+1jkh− upijkotherwise.(13)pi+1 jk∼ is the interpolated value of up at thewhere h is the sampling interval of the grid, and uintersection of the line segment connecting (i, j, k) and (i + 1, j, k) and the extended surface ofp includes two pointsa landmark curve. The numerical stencil used here in computing D+(i, j, k) and (i + 1, j, k). If they are connected, the usual first order forward difference schemeis adopted; but if they are not, the flow between these two points should be blocked and weassume a constant extension of the boundary condition from the point of intersection to (i + 1,p to from the extended surfaces is used to replace ui+1 jky,y, D−p . Using the same method, the first order difference operators D−∼j, k). Thus the boundary value upi+1 jkxuijkxuijkx, D+compute D+z, D−D+z can also be defined.To demonstrate second order numerical schemes, we define the operator D−direction as follows:xD+x in the xxD−xD+upijkx+upijkxD+upijk={ Dx− D+upi−1jkhx∼− D+upi−1jkhif (i, j, k) and (i − 1, j, k) are connected,otherwise.(14)I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscript= (uijkpi−1 jkp∼p − ui−1 jk∼) ∕ h with ux∼p as the interpolated value of up at thewhere Dui−1 jk+intersection between the line segment connecting (i, j, k) and (i − 1, j, k) and the extendedp includessurface of a landmark curve. The numerical stencil used for computing D−three points (i − 1, j, k), (i, j, k) and (i + 1, j, k). The case that (i, j, k) and (i + 1, j, k) could bedisconnected is already handled in the definition of D+p . If (i − 1, j, k) and (i, j, k) arexuijkxuijkxD+Med Image Anal. Author manuscript; available in PMC 2008 June 1.   I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptShi et al.Page 9connected, the usual first forward then backward scheme is used. If these two points aredisconnected, we once again assume constant extension of the boundary condition from thex∼p toextended surface and block the flow between them by using the interpolated Dui−1 jk+p . Following the same principle, we can define D−z similarly.zD+y and D−replace D+xui−1 jkyD+We next assemble all the building blocks of our numerical schemes to solve the PDE in (10)with landmark constraints. At time t, we denote the map u at a point (i, j, k) as uijk(t), and wewant to derive the update scheme to compute uijk (t + 1) at the next time step. If we ignore theprojection operator to the target surface ∏ψ(uijk(t)) for a moment, we can treat each componentof u separately because:∇ ⋅ (∏ϕJT) =u1)∇ ·(∏ϕ∇u∇ ·(∏ϕ∇u2)3)∇ ·(∏ϕ∇u.(15)p (t) = ∇ ⋅ (∏ϕ∇up) (p = 1, 2, 3). Following (Mémoli et al., 2004a), we approximateLet δuijkthe gradient with the forward difference scheme and the divergence with a backward differencescheme. The numerical scheme for computing δuijkp (t) is:δupi,j,kx(t) = D−yD−z ∏∇ϕD−ijkxD+yD+z TD+upijk(t),where the projection matrix ∏∇ϕijk at point (i, j, k) is computed using the standard central2 δuijk1 δuijkdifference scheme. Let δuijk = δuijk(10) with landmark constraints is as follows:3 T. Our complete numerical scheme to solveuijk(t+ 1) − u(t)ijkΔt= ∏∇ψ(u(t)) δuijk(t)ijk(16)where Δt is the time step, which is selected to be bounded by the stability condition in (Mémoliet al., 2004a). The projection operator ∏Δψ(uijk(t)) is also computed using the standard centraldifference scheme.The update equation in (16) for the harmonic map is an explicit numerical scheme which wechose for its simplicity. For numerical efficiency, other schemes such as implicit schemes canalso be used and are part of our future research. Our method of incorporating boundaryconditions, however, is general and can be easily adapted into these more advanced numericalschemes.4 Initialization Using Landmark ContextThe numerical algorithm developed in the previous section modifies the gradient descent flowof the harmonic energy with adaptive operators for computing first and second order partialgradients, so it is still essentially a steepest descent algorithm. This makes the selection of agood initialization a critical step for a successful mapping since the optimization of thevariational problem in (11) and (12) is non-convex as pointed out in section 2.For a high dimensional optimization problem such as cortical mapping, it appears at first to bea daunting task to find a suitable initial map. However the search space can be greatly reducedMed Image Anal. Author manuscript; available in PMC 2008 June 1.   I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptShi et al.Page 10if we utilize our prior knowledge about the map. First the value of the map u on the set of sulcallandmark curves on the source manifold ℳ is already given as our boundary condition. Wealso know that u should be interpolated smoothly in areas between these sulcal curves, whichis the point of minimizing the harmonic energy. Based on this knowledge, we propose a novelfront propagation type approach to find a good initial map. All the sulcal curves act as thesource of the front propagation in the beginning of our algorithm. We then move outward tofind the map at their neighboring points by searching locally for the best correlation of a featurewe call landmark context, which is defined at each point on both the source and target corticalsurface. These newly mapped points then serve as the current source of the front and we repeatthe above process until the whole source cortical surface is covered.Our definition of the landmark context feature on the cortical surface is partly motivated bythe idea of shape context (Belongie et al., 2002) in computer vision. For a shape viewed as apoint set, the shape context feature at each point is defined as a distribution of the relativelocations of other points on the shape with respect to this point. This has proved to be a verypowerful idea for shape matching and object recognition (Tu and Yuille, 2004). Following thesame principle, we define the landmark context for each point p∈ M as follows:1LCM(p) = d(p, CM2), d(p, CMK), ⋯ , d(p, CM) ,(17)k to p. Compared with the feature of shape context, our landmarkk(k = 1, ⋯ , K) is the set of sulcal landmark curves on ℳ and d(p, CMwhere CMgeodesic distance from CMcontext feature is computationally more tractable. Its calculation only involves the computationof the distance transform for a limited set of curves, while shape context needs to compute ateach point the distribution of the rest of the shape. If we view the landmark curves as the axesof a coordinate system on the cortex, the distances to them at each point intuitively play therole of coordinates and give us a very good indicator of the relative location of the point on thecortical surface.k) is theIn searching for the initial map with landmark context, we find it convenient to use the triangularmesh representation of the cortical surfaces, which is typically the original representation ofour data, since we need to work directly with points on the surface and their relation tolandmarks. Once we find the initial map on the triangular mesh, we then embed the mesh intothe narrow band of the level-set function ϕ and extend the map along the normal direction tothe whole narrow band. This is used as the initialization of the iterative PDE-based algorithmdescribed in section 3.Without causing confusion, we will still use the notation ℳ and to denote the triangularmesh representation of the source and target cortical surface. Each of them is composed of aset of vertices and faces. The set of sulcal curves on ℳ is {CMcorresponding set of sulcal curves on k(k = 1, ⋯ , k)}. At the start of our algorithm,k(k = 1, ⋯ , k)}, with the as {CN usingwe compute the geodesic distance transform for each of the sulcal curve on ℳ and the fast marching algorithm on triangular meshes ( Kimmel and Sethian, 1998). At each vertexof the meshes, we record its distance to all sulcal curves and form its landmark context. Afterthis step, the landmark context is defined at each vertex of ℳ and .We next find the initial map at vertices close to the landmark curves and use them as the startingk on ℳ andpoint of the front propagation process over the triangular mesh ℳ. For a curve CMits corresponding curve CN, we sample both of them uniformly into L points. For eachk on Med Image Anal. Author manuscript; available in PMC 2008 June 1.   I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptShi et al.Page 11k, we find the closest vertex on k, we find the closest vertex on ℳ and push it into a heap Hℳ. Similarly, and push it into a heap HN., we haveof the L points on CMfor each of the L points of CNAfter this process is repeated for every pair of sulcal landmark curves on ℳ and two heaps Hℳ and HN with matched vertices and are ready to march outward. Note that thesame vertex can appear multiple times in a heap since more than one point on a sulcal curvecan have the same vertex as its closest match. For the heap Hℳ, this means one vertex is matched. Our algorithm simply uses the first match in HN as the initial map.to multiple vertices in is matched by multiple vertices in ℳ, and weFor the heap HN, this means one vertex in just leave it as it is and let the PDE-based approach improve the map.Once both heaps are initialized, we start the front propagation process to find the initial mapfor all vertices on ℳ. The matched vertices in Hℳ and HN are used as seed points for findingnew matched pairs. In each step we pop out the first element of Hℳ and HN, and denote themas pS and pT respectively. If the match result at the point pS has already been found, we skipfurther processing and move on to the next pair of matched vertices in the heaps. Otherwise,we save pT as the mapping result of pS and search the mapping for neighboring vertices ofpS. To clarify the meaning of neighbors in a mesh, we use the notion of the k-ring neighborhoodof a vertex that is defined as the set of vertices within k edges away from this vertex. For each, we search for itsvertex in the 1-ring neighborhood of pS that has not found a match in match locally in a P-ring neighborhood of pT with the highest correlation of their landmarkcontext, which means they have the most similar relative location with respect to the set ofsulcal curves on the corresponding cortex. Typically we choose P = 5 in our experiments. Oncewe find a match, we push them into Hℳ and HN. After the search is finished for all 1-ringneighbors of pS, we pop out new elements from Hℳ and HN and continue the above procedureuntil the heaps become empty.As a summary, the complete algorithm of finding the initial map is listed in Table I.5 Extension To Energy With Data TermsWe have so far developed a complete solution for direct cortical mapping by minimizing theharmonic energy with landmark constraints. But the implicit mapping technique offers us lotsof flexibility in defining and minimizing energy functions on surfaces. In this section, wedemonstrate this generality by extending the energy function in (11) with data terms.We first define two feature functions f1 : M → R and f2 : N → R on the source and targetcortical surface. We limit the feature to be scalar for simplicity, but the extension to vectorialfeatures is straightforward. We also define a weight function w : M → R as follows:w(p) ={1 + e210∗(h−d(p))∕h ifd(p) < h,1otherwise(18)for each p∈ M. Here d(p) = min LC M(p) is the minimum of the landmark context at p andh is the sampling interval of the grid. The weight function w decreases from one to 2/(1 +e10) as d(p) approaches zero. Using the fast marching algorithm, we extend f1, f2 and w to thenarrow band of ϕ and ψ along the normal direction, which are the implicit representations ofMed Image Anal. Author manuscript; available in PMC 2008 June 1.   I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptShi et al.Page 12ℳ and a data term:. We then define our new energy function that combines the harmonic energy withwhere λ is a non-negative regularization parameter. The data term in the new energy functionis a weighted least square term that penalizes the difference between the feature function onthe source and cortical surface. Since the weight function is almost zero in the neighborhoodof sulcal curves, the data term will not violate the landmark constraints in (12).After computing the first variation of the energy, we obtain the gradient descent flow of themap u as:∂ u∂t= ∏∇ψ(u(x,t)) (∇ ⋅ (∏∇ϕJTu)) + λw(f1− f2(u))∏∇ψ(u(x,t)) ∇ f2(u)(20)where the term Π∇ψ(u(x,t)) ∇f2(u) is the intrinsic gradient of f2 at u ∈ N. To solve this equationnumerically and minimize the new energy function, we apply the adaptive schemes wedeveloped in section 3 and obtain the following numerical scheme that updates uijk from timet to t + 1:uijk(t+ 1) − u(t)ijkΔ t= ∏∇ψ(uijk(t)) δuijk(t) + λw(f1− f2(uijk(t)))∏∇ψ(u(t)) ∇ f2(uijk(t))ijk(21)where δuijk(t) and Π∇ψ(uijk(t)) are the same as in (16), and the standard central differencescheme is used to compute ∇ f2(uijk(t)).Besides the least square energy in (19), we can also incorporate other data terms into ourextended energy function. For example, it can be the correlation between features, or theirmutual information (Wells et al., 1996;Wang et al., 2005a). Thus our method opens up animportant opportunity for designing customized data terms that suit the need of specific brainmapping problems.6 Experimental ResultsThe inputs to our direct mapping method include both the cortical surfaces and the sulcallandmark curves defined on the two surfaces. The cortical surfaces used in our experimentsare generated using the algorithm in (MacDonald, 1998) in the form of triangular meshes,which were used in many neuroscience studies (Thompson et al., 2004). While the corticalsurface generated from this algorithm may not reach the deepest parts of some sulcal regions,it captures all the major sulci and thus could be viewed as an approximation at certain scale ofthe pial surface that represents the outer boundary of the cortex. It is also convenient for manualtracing of sulcal landmarks on these smooth surfaces. But the direct cortical mapping methodpresented here is not limited to specific surface models and can also be applied to corticalsurfaces extracted from other algorithms.We compute the implicit representations of the cortical surfaces by converting each of themto a signed distance function with the fast marching algorithm. For the solution of PDEs onimplicit surfaces, the signed distance function is only defined in a narrow band. In our numericalalgorithms, we use an effcient sparse data structure DTGrid proposed in (Nielsen and Museth,in press) to represent the narrow band. The set of landmark curves are delineated using aMed Image Anal. Author manuscript; available in PMC 2008 June 1.   I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptShi et al.Page 13protocol that defines 36 sulcal and landmark curves. Each curve is sampled to a fixed numberof points with curve length parameterization. One-to-one correspondences between curves ondifferent cortexes can then be established and used as constraints in our variational framework.In our first two experiments, we compute the direct map between a pair of cortices byminimizing the harmonic energy in (8) and the extended energy in (19). These two experimentsillustrate various properties of our direct mapping method. After that, we apply our algorithmto a group of 30 subjects and compare the property of metric distortion with a parametricmapping method. Finally, we apply our method to the application of cortical atlas constructionand variability analysis.6.1 Direct Mapping of Two Cortices with Harmonic EnergyIn this experiment, we compute a map from a source cortex to a target cortex by minimizingthe harmonic energy with sulcal landmark constraints. This experiment will illustrate the roleof each step in our algorithm towards the generation of a direct map. The results from thisexperiment will also demonstrate the convergence property of our algorithm in optimizing theharmonic energy and its ability to improve the conformality of the mapping by reducing angledistortions.The data used in this experiment, including the source and target cortex and their landmarkcurves, are shown in Fig. 4. A set of extend surfaces, as shown in Fig. 5, are constructed fromthe landmark curves in Fig. 4(c) using the algorithm proposed in section 3 to extend theboundary condition off the source cortical surface.For the triangular mesh of both the source and target cortical surfaces, we then compute thelandmark context at each vertex using the set of landmark curves. Based on this result, an initialmap is then computed using the algorithm developed in section 4. To visualize this map, wefirst pull a checkerboard pattern onto the source cortex using the conformal mapping algorithmin (Gu et al., 2004). The lateral and medial view of this pattern on the source cortex are shownin Fig. 6(a) and (b). The checkerboard pattern is then projected onto the target cortex with theinitial map and the results are shown in Fig. 6(c) and (d). Even though the initial map mayappear quite good, we can clearly see noisy distortions at various locations such as the regionsinside the black ellipses in both views. The initial map defined on the triangular mesh isextended to the narrow band along normal directions with the fast marching algorithm suchthat ∇u · ∇ϕ = 0.With the initial map provided from the previous step, we start our numerical algorithm thatsolves the PDE in (10). The parameters in our algorithm are chosen as: the sampling intervalof the grid h = 1 mm and the time step Δt = 0.1. To prevent the map u from drifting away fromthe target surface due to numerical errors, we project it back onto the target surface using theoperator Πψ(uijk(t)) every 5 iterations. As a common practice in level-set techniques, the mapis also re-initialized every 30 iterations such that the property ∇u·∇ϕ = 0 is approximatelysatisfied. The final mapping result is obtained after 5000 iterations. The total computation timeis around 4 hours on a 3.19GHz PC.In this iterative solution process, the harmonic energy function is reduced over time andconverges toward the end of iterations as we show in Fig. 7. The direct map computed fromour algorithm is visualized in Fig. 6(e) and (f) by projecting the checkerboard pattern on thesource cortical surface shown in Fig. 6(a) and (b) to the target cortical surface. In comparisonwith the projected pattern using the initial map as shown in Fig. 6(c) and (d), we can see clearlythat the smoothness of the map is improved significantly, for example in regions highlightedby the black ellipses. This is the desired result from the minimization of the harmonic energy.Because of our adaptive numerical schemes, the landmark constraints are maintained as weMed Image Anal. Author manuscript; available in PMC 2008 June 1.   I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptShi et al.Page 14solve the PDE over time. To illustrate this point, we have plotted the final map on seven majorsulcal curves in Fig. 8 and we can see clearly the landmark constraints are satisfied. This showsthat a smooth map is obtained while satisfying the landmark constraints.An important property of the harmonic map is that it is also conformal when the target surfaceis of non-negative curvature (Gu et al., 2004). Even though there is no such guarantee in thedirect map we computed because of the convoluted nature of the target surface and the presenceof landmark constraints, we still observe in our experiment the improvement in conformalityas the harmonic energy is minimized. To illustrate this property, we computed the angledistortions in the checkerboard pattern as we project it onto the target cortex. The histogramof the angle distortions resulted from the initial and final map are plotted in Fig. 9 (a) and (b).The mean of both histograms are approximately zero, but the standard deviation improves from31.8831° to 26.5888°. This shows the magnitude of angle distortions are reduced as theharmonic energy is minimized.The above experiment demonstrates that a smooth map between the source and target corticalsurface is generated from our direct mapping algorithm. For validation purposes, we have alsoapplied the above process to map the source cortical surface in Fig. 4(a) to itself. We thenmeasure the distance between each vertex and its image under the resulting mapping to quantifynumerical accuracy. Because of the finite resolution of the implicit representation, this distancewill not be zero but should be on the same order as the grid resolution. Indeed the result verifiesour intuition and the average distance over all vertices is 0.47mm, which is less than the gridinterval that we chose as h = 1mm to match the resolution of the input triangular meshrepresentation of the cortical surfaces.6.2 Cortical Mapping with Data TermsIn the second experiment, we demonstrate direct cortical mapping from the minimization ofthe energy in (19) with both the harmonic energy and a data term. We choose the feature f1and f2 as the mean curvature of the cortical surfaces in this experiment. By penalizing thedifference between mean curvature in the energy function, our goal is to obtain a smooth mapthat also matches similar geometric property.We use the same data in the first experiment as shown in Fig. 4. The mean curvature of thesource and target cortex are shown in Fig. 10. The regularization parameter is chosen as λ =60. Because of the extra data term, we choose a smaller time step Δt = 0.01 for numericalstability. We use the result from the first experiment as our initial map and update it iterativelyaccording to (21) to compute the minimizer of the energy in (19). The total energy convergesover time as shown in Fig. 11(a) and we obtain the final result after 3000 iterations. As in thefirst experiment, we visualize the result by mapping the checkerboard pattern on the sourcecortex in Fig. 6 (a) and (b) to the target cortex in Fig. 12 (a) and (b).Comparing the projected checkerboard pattern in Fig. 12 (a) and (b) to that in Fig. 6 (e) and(f), we can see it is less smooth in various locations, such as the frontal lobe. This is reflectedin the monotonic increase of the harmonic energy, shown in Fig. 11(b), as the total energy isminimized. It shows that the incorporation of the data term shifts the map from its initial valueas the minimizer of the harmonic energy. We have also plotted in Fig. 11(c) the change of thedata term energy, which is the weighted least square of the difference between the meancurvature on the two cortices. We can see it decreases over time and reduces to less than halfof its initial value. This shows quantitatively we have a better match of the mean curvatureprofile between the source and target cortex.Med Image Anal. Author manuscript; available in PMC 2008 June 1.   I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptShi et al.Page 156.3 Quantitative Comparisons with a Parametric Mapping MethodIn this section, we compare the metric distortion property of our direct mapping method and aparametric mapping method. Since data terms are not included for most parametric mappingalgorithms with landmark constraints, we use only the harmonic energy in our comparison.With sulcal landmark constraints, the goal of our direct mapping method is to compute a mapthat interpolates smoothly between these landmark curves. Ideally the map should be as closeas possible to an isometry up to a scaling factor for regions between corresponding landmarkcurves on the source and target cortical surfaces. To validate this property, we will first proposean approach to measure the metric distortion of a map between cortices with landmarkconstraints. Quantitative comparisons are then performed between our direct mappingalgorithm and a popular parametric mapping algorithm on a group of 30 subjects.For ease of comparison with parametric approaches, we define the metric distortion measure denote two that establishes a one to onein terms of the triangular mesh representation of cortical surfaces. Let ℳ and triangular meshes and u the mapping from ℳ to correspondence between vertices of ℳ and . For a vertex x in the source mesh ℳ, we candefine a circular patch C(x) on ℳ as its geodesic neighborhood of radius r. Let the set of verticesM.L and their geodesic distances to x as dithat fall inside this patch C(x) be denoted as {yi}i=1This set of geodesic distances can be organized into a lower triangular matrix T with its elementsML } inside thedefined as Tij = dii=1patch u(C(x)) on the target mesh . Their geodesic distances to u(x) are denoted as dithey can also be organized into a lower triangular matrix T* with its elements defined asN. Following (Tosun et al., 2004), we define as follows a metric distortionM. Correspondingly, we have the set of vertices {u(yi)N and∕ dj∗ = diN ∕ djTijmeasure to test the quality of the map locally:I =1∑i<jTij∑i<j(Tij2− T∗)ijTij.(22)This measure quantifies the metric distortion from the source patch C(x) to the target patch u(C(x)). The lower the measure ℐ, the more similar are the two patches. This measure is zerowhen the map is locally an isometry up to a scaling factor from C(x) to u(C(x)), in which caseN is simply a scaling of didi(i = 1, ⋯ , L).MEven though the measure ℐ in (22) is defined formally as in (Tosun et al., 2004), the scenarioof its application here is different. In (Tosun et al., 2004), it is used to measure the global metricdistortion over the whole cortex under spherical mapping with no landmark constraints. In acortex to cortex mapping, however, each part of the cortex is stretched or compresseddifferently due to enforcement of the landmark constraints. To quantify how smooth theboundary conditions are interpolated between sulcal curves, we should avoid mixing differentinterpolation effects across different sides of these curves. Thus the patches used for theevaluation of metric distortions should not cross any sulcal curves. For a given radius r, thiscan be ensured by choosing the center point of the patch as those vertices x with minmin LC M(x) > r, where LC M(x) is the landmark context of x computed from the set oflandmark curves on ℳ.Using the metric distortion measure ℐ, we next compare our algorithm experimentally with apopular parametric approach proposed in (Thompson et al., 2000b, 2004). For a source cortexand a target cortex, this approach first maps them to spherical coordinates and then solves aMed Image Anal. Author manuscript; available in PMC 2008 June 1.   I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptShi et al.Page 16system of partial differential equations governed by the Cauchy-Navier differential operatorto compute the map. The covariant forms of the differential operators are used to take intoaccount the Riemannian metric of the cortical surfaces. Once the map is computed in thespherical domain, it can be pulled back to the original cortices and we denote it as are triangular mesh representations of the source and targetu1 : M → Ncortex. With our direct mapping approach, we also compute a map u2 for the same pair ofcortices without the intermediate parameterization steps. Since the map u2 is defined in anarrow band of the source cortex, we can obtain its value on each vertex of ℳ easily usingsimple linear interpolations on the Cartesian grid. The image of ℳ on the target cortex underthe map u2 is denoted as N, where ℳ and N112 = u2(M).1 with the parametric approach and the map u2 : M → NIn our experiment, we compare the metric distortion properties of the two different mappingmethods on a group of 30 cortices. We divide this group into 15 pairs randomly such that eachpair has a source cortex and a target cortex. For each pair, we compute both the map with our direct mappingu1 : M → Nmethod. For both u1 and u2, the metric distortion measure ℐ is computed at 5000 randomlyselected circular patches of radius r = 5 on the source cortex ℳ. As we pointed out above, thesepatches do not cross any sulcal curves. The mean and standard deviation of the metric distortionmeasure at these 5000 patches are computed for both u1 and u2 and plotted for the whole groupin Fig. 13(a) and (b). From these plots, we can see that our direct mapping algorithm performsbetter in terms of both the mean and standard deviation of the metric distortion.2The above experiment shows that metric is better preserved in the direct map computed fromthe minimization of the harmonic energy, but we readily acknowledge that this is far from athorough comparison between our direct mapping method and parametric mapping approaches,which is a very difficult task because both types of methods have their relative strength andweakness. The biggest advantage of our direct mapping method is that the whole mappingprocess is simplified by skipping the intermediate parameterization steps. The direct mappingmethod is also flexible in that it can incorporate variational energies with generic data terms.The parametric mapping approach, however, does have advantages in ensuring thediffeomorphic property of the map. The Eells-Sampson theorem (Eells and Sampson, 1964)tells us that the harmonic map from the cortical surface to the sphere is a diffeomorphism. The2D warping process that matches landmark curves can also be guaranteed diffeomorphic withthe work of computing large deformation diffeomorphisms (Christensen et al., 1996; Joshi andMiller, 2000). This ensures the final cortex to cortex map to be a diffeomorphism. Currentlyour direct mapping method is not provably diffeomorphic, but our experimental resultsdemonstrate that it can obtain smooth maps of good metric preserving quality. Theoreticallyit is also possible for the heat flow of harmonic maps to have singularities under boundaryconstraints (Hardt, 1997). Finite-time blow-ups of a heat flow that maps from a disk to thesphere were reported in (Chang et al., 1992). But practically the direct cortical mapping methodis very stable in our experience, probably due to the constraints imposed by the sulcallandmarks. We illustrate next that this new method can be easily applied to typical brainmapping applications such as cortical atlas construction and variability analysis.6.4 Application: Cortical Atlas ConstructionAtlas construction is a critical step in brain mapping. It integrates information from multiplebrains and offers a framework for visualization and many analysis tasks, such as brainvariability and asymmetry (Toga et al., 2001). In this section, we demonstrate atlas constructionfrom the results of our direct mapping method using conventional cortical atlas constructiontechniques based on parametric surface representations.Med Image Anal. Author manuscript; available in PMC 2008 June 1.   I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptShi et al.Page 17Let M0, M1, ⋯ , MK be a group of cortical surfaces represented as triangular meshes. Theirimplicit representations are correspondingly a group of signed distance functionsϕ0, ϕ1, ⋯ , ϕK. For simplicity we use ℳ0 as the source cortex and apply our direct mappingalgorithm to compute K maps from ϕ0 to ϕk(k = 1, ⋯ , K) with landmark constraints. The Kdirect maps from our algorithm are computed in the narrow band of ℳ0 where its implicitrepresentation ϕ0 is defined. To obtain values of the direct map on the vertices of ℳ0, we uselinear interpolation. This provides us K explicit maps uk : Mtriangular mesh ℳ0, which projects each vertex of ℳ0 onto Midentity map from ℳ0 onto itself. With these maps, we can construct the cortical atlas M¯ as theaverage of this group of cortical surfaces. The averaging process is defined formally as follows:(k = 1, ⋯ , K) on the. We also denote u0 as the0 → MkkM¯ =1K + 1κ∑k=0(Muk).0(23)which defines that each vertex of the atlas M¯ is the mean of K + 1 corresponding points on theset of cortical surfaces M0, M1, ⋯ , MK.As a simple application of this atlas, we can compute the variability at each vertex of the corticalatlas and it is defined formally as:var(M¯) =K1K ∑k=0∥ uk(M0) − M¯∥2,(24)where ∥ · ∥ denotes the l2 norm of vectors in R3. At each vertex of M¯, this equation computesthe variance of the coordinates of its corresponding points on M1, ⋯ , MK established bythe maps u0, u1, ⋯ , uK.0, MWe present next experimental results of atlas construction from a group of nine left hemispheresas shown in Fig. 14. The cortex in the middle is used as the source cortex ℳ0 and we computethe map from this source cortex to the rest of eight cortices by minimizing the harmonic energy.After that, the cortical atlas is computed using (23) and shown from both the lateral and medialview in Fig. 15(a) and (b). Since sulcal landmark constraints are strictly followed in our directmapping algorithm, major sulcal curves are still clearly visible in the atlas. Using the corticalatlas, we also computed the variability map using (24). The lateral and medial view of this mapare shown in Fig. 16(a) and (b). From this map on the cortical atlas, we can observe that thefrontal, temporal and parietal-occipital lobes exhibit different degrees of variability among thisgroup of subjects.7 ConclusionsIn this paper we proposed a direct mapping approach to compute maps between corticalsurfaces with sulcal landmark constraints. This new method can avoid intermediateparameterizations in conventional approaches and greatly simplify the cortical mappingprocess. The direct mapping method is also very flexible and it can compute maps as theminimizer of variational energies with both the harmonic energy and general data fidelity terms.Experimental results demonstrate that our method can compute smooth maps between corticalsurfaces while respecting landmark constraints. The application of our algorithm for corticalatlas construction and variability analysis in brain mapping were also presented.Med Image Anal. Author manuscript; available in PMC 2008 June 1.   I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptShi et al.AcknowledgementsPage 18This work was funded by the National Institutes of Health through the NIH Roadmap for Medical Research, GrantU54 RR021813 entitled Center for Computational Biology (CCB). Information on the National Centers for BiomedicalComputing can be obtained from http://nihroadmap.nih.gov/bioinformatics.References1. Angenent S, Haker S, Tannenbaum A, Kikinis R. On the Laplace-Beltrami operator and brain surfaceflattening. IEEE Trans Med Imag 1999;18(8):700–711.2. Avants B, Gee JC. Geodesic estimation for large deformation anatomical shape averaging andinterpolation. NeuroImage 2004;23:S139–S150. [PubMed: 15501083]3. Belongie S, Malik J, Puzicha J. Shape matching and object recognition using shape contexts. IEEETrans Pattern Anal Machine Intell 2002;24(4):509–522.4. Bertalmío M, Cheng L, Osher S, Sapiro G. Variational problems and partial differential equations onimplicit surfaces. Journal of Computational Physics 2001;174(2):759–780.5. Bertalmío M, Sapiro G, Randall R. Region tracking on level-sets methods. IEEE Trans Med Imag1999;18(5):448–451.6. Besl PJ, McKay N. A method for registration of 3-D shapes. IEEE Trans Pattern Anal Machine Intell1992;14(2):239–256.7. Burchard P, Cheng LT, Merriman B, Osher S. Motion of curves constrained in three dimensions usinga level set approach. Journal of Computational Physics 2001;170(2):720–741.8. Burger, M. Finite element approximation of elliptic partial differential equations on implicit surfaces.UCLA CAM; Aug. 2005 p. 05-46.Tech. Rep.9. Cachier P, Mangin JF, Pennec X, Rivière D, Orfanos DP, Régis J, Ayache N. Multisubject non-rigidregistration of brain MRI using intensity and geometric features. Proc MICCAI 2001:734–742.10. Carman GJ, Drury HA, Van Essen DC. Computational methods for reconstructing and unfolding thecerebral cortex. Ceberal cortex 1995;5:506–517.11. Chang KC, Ding WY, Ye R. Finite-time blow-up of the heat flow of harmonic maps from surfaces.J Differential Geom 1992;36(2):507–515.12. Chen S, Merriman B, Osher S, Smereka P. A simple level set method for solving Stefan problems.Journal of Computational Physics 1997;135:8–29.13. Cheng LT, Burchard P, Merriman B, Osher S. Motion of curves constrained on surfaces using a level-set approach. Journal of Computational Physics 2002;175(2):604–644.14. Christensen GE, Rabbitt RD, Miller MI. Deformable templates using large deformation kinematics.IEEE Trans Imag Process 1996;5(10):1435–1447.15. Clouchoux C, Coulon O, Rivière D, Cachia A, Mangin JF, Régis J. Anatomically constrained surfaceparameterization for cortical localization. Proc MICCAI 2005:344–351.16. Collins DL, Goualher GL, Evans AC. Non-linear ceberal registration with sulcal constraints. ProcMICCAI 1998:974–984.17. Davatzikos C, Vaillant M, Letovsky S, Bryan RN, Prince JL, Resnick SM. A computerized approachfor morphological analysis of the corpus callosum. Journal of Computer Assisted Tomography1996;20(1):88–97. [PubMed: 8576488]18. Drury HA, Van Essen DC, Anderson CH, Lee CW, Coogan TA, Lewis JW. Computerized mappingsof the cerebral cortex: A multiresolution flattening method and a surface-based coordinate system. JCogn Neuro 1996;8(1):1–28.19. Dupuis P, Grenander U, Miller MI. Variational problems on flows of diffeomorphisms for imagematching. Quarterly of Applied Mathematics 1998;LVI(3):587–600.20. Eells, J.; Lemaire, L. Two reports on harmonic maps. World Scientific; 1995.21. Eells J, Sampson JH. Harmonic mappings of Riemannian manifolds. Ann J Math 1964;86:109–160.22. Fischl B, Sereno MI, Dale AM. Cortical surface-based analysis ii: Inflation, flattening, and a surface-based coordinate system. NeuroImage 1999a;9(2):195–207. [PubMed: 9931269]23. Fischl B, Sereno MI, Tootell RBH, Dale AM. High-resolution intersubject averaging and a coordinatesystem for the cortical surface. Human Brain Mapping 1999b;8:272–284. [PubMed: 10619420]Med Image Anal. Author manuscript; available in PMC 2008 June 1.   I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptShi et al.Page 1924. Glaunes J, Vaillant M, Miller MI. Landmark matching via large deformation diffeomorphisms on thesphere. J Math Imaging Vis 2004;20:179–200.25. Greer, J. An improvement of a recent Eulerian method for solving PDEs on general geometries. UCLACAM; Jun. 2005 p. 05-41.Tech. Rep.26. Greer, J.; Bertozzi, A.; Sapiro, G. Fourth order partial differential equations on general geometries.UCLA CAM; Mar. 2005 p. 05-17.Tech. Rep.27. Grenander U, Miller MI. Computational anatomy: An emerging discipline. Quarterly of AppliedMathematics 1998;LVI(4):617–694.28. Grossman R, Kiryati N, Kimmel R. Computational surface flattening: a voxel-based approach. IEEETransactions on Pattern Analysis and Machine Intelligence 2002;24(4):433–441.29. Gu X, Wang Y, Chan TF, Thompson PM, Yau ST. Genus zero surface conformal mapping and itsapplication to brain surface mapping. IEEE Trans Med Imag 2004;23(8):949–958.30. Hardt RM. Singularites of harmonic maps. Bulletin of the Americal Mathematical Society 1997;34(1):15–34.31. Hellier P, Barillot C. Coupling dense and landmark-based approaches for nonrigid registration. IEEETrans Med Imag 2003;22(2):217–227.32. Hurdal MK, Bowers PL, Stephenson K, Sumners DWL, Rehm K, Schaper K, Rottenberg DA. Quasi-conformally flat mapping the human cerebellum. Proc MICCAI 1999:279–286.33. Hurdal MK, Stephenson K. Cortical cartography using the discrete conformal approach of circlepackings. NeuroImage 2004;23:S119–S128. [PubMed: 15501081]34. Joshi A, Shattuck DW, Thompson PM, Leahy RM. Cortical surface parameterization by p-harmonicenergy minimization. Proc IEEE Int Symp Biomed Imag 2004:428–431.35. Joshi S, Miller MI. Landmark matching via large deformation diffeomorphisms. IEEE Trans ImagProcess 2000;9(8):1357–1370.36. Ju L, Stern J, Rehm K, Schaper K, Hurdal M, Rottenberg D. Cortical surface flattening using leastsquare coformal mapping with minimal metric distortion. Proc IEEE Int Symp Biomed Imag2004:77–80.37. Kimmel R, Sethian JA. Computing geodesic paths on manifolds. Proc Natl Acad Sci USA 1998;95(15):8431–8435. [PubMed: 9671694]38. Leow A, Yu CL, Lee SJ, Huang SC, Protas H, Nicolson R, Hayashi KM, Toga AW, Thompson PM.Brain structural mapping using a novel hybrid implicit/explicit framework based on the level-setmethod. NeuroImage 2005;24:910–927. [PubMed: 15652325]39. MacDonald, D. Ph.D. thesis. McGill Univ; Canada: 1998. A method for identifying geometricallysimple surfaces from threee dimensional images.40. Mémoli F, Sapiro G, Osher S. Solving variational problems and partial differential equations mappinginto general target manifolds. Journal of Computational Physics 2004a;195(1):263–292.41. Mémoli F, Sapiro G, Thompson PM. Implicit brain imaging. Neuroimage 2004b;23(Suppl 1):S179–S188.42. Mémoli, F.; Sapiro, G.; Thompson, PM. Brain and surface warping via minimizing Lipschitzextensions. University of Minesota; 2006. Tech. Rep. IMA Preprint #209243. Nielsen MB, Museth K. Dynamic Tubular Grid: An effcient data structure and algorithms for highresolution level sets. Journal of Scientific Computing. in press44. Osher S, Sethian J. Fronts propagation with curvature-dependent speed: algorithms based onHamilton-Jacobi formulations. Journal of computational physics 1988;79(1):12–49.45. Ratz, A.; Voigt, A. PDE’s on surfaces – a diffuse interface approach. UCLA CAM; Nov. 2005 p.05-62.Tech. Rep.46. Schwartz EL, Merker B. Computer-aided neuroanatomy: differential geometry of cortical surfacesand an optimal flattening algorithm. IEEE Computer Graphics and Applications 1986;6(3):36–44.47. Schwartz EL, Shaw A, Wolfson E. A numerical solution to the generalized mapmaker’s problem:flattening nonconvex polyhedral surfaces. IEEE Trans Pattern Anal Machine Intell 1989;11(9):1005–1008.48. Sereno MI, Dale AM, Liu A, Tootell RBH. A surface-based coordinate system for a canonical cortex.NeuroImage 1996;3:S252.Med Image Anal. Author manuscript; available in PMC 2008 June 1.   I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptShi et al.Page 2049. Sethian J. A fast marching level set method for monotonically advancing fronts. Proc Nat Acad Sci1996;93(4):1591–1595. [PubMed: 11607632]50. Thompson PM, Giedd JN, Woods RP, MacDonald D, Evans AC, Toga AW. Growth patterns in thedeveloping brain detected by using continuum-mechanical tensor maps. Nature 2000a;404(6774):190–193. [PubMed: 10724172]51. Thompson PM, Hayashi KM, Sowell ER, Gogtay N, Giedd JN, Rapoport JL, de Zubicaray GI, JankeAL, Rose SE, Semple J, Doddrell DM, Wang Y, van Erp TGM, Cannon TD, Toga AW. Mappingcortical change in alzheimers disease, brain development, and schizophrenia. NeuroImage2004;23:S2–S18. [PubMed: 15501091]52. Thompson PM, Toga AW. A surface-based technique for warping three-dimensional images of thebrain. IEEE Trans Med Imag 1996;15(4):1–16.53. Thompson PM, Woods RP, Mega MS, Toga AW. Mathematical/computational challenges in creatingpopulation-based brain atlases. Hum Brain Mapp 2000b;9(2):81–92. [PubMed: 10680765]54. Timsari B, Leahy R. Optimization method for creating semi-isometric flat maps of the cerebral cortex.Proc SPIE Conf Med Imag 2000:698–708.55. Toga, AW. Brain Warping. Academic Press; New York: 1998.56. Toga AW, Thompson PM. Mapping brain asymmetry. Nat Rev Neurosci 2003a;4(1):37–48.[PubMed: 12511860]57. Toga AW, Thompson PM. Temporal dynamics of brain anatomy. Annu Rev Biomed Eng 2003b;5:119–145. [PubMed: 14527311]58. Toga AW, Thompson PM, Mega MS, Narr KL, Blanton RE. Probabilistic approaches for atlasingnormal and disease-specific brain variability. Anat Embryol 2001;204:267–282. [PubMed:11720233]59. Tosun D, Prince JL. Cortical surface alignment using geometry driven multispectral optical flow.Proc IPMI 2005:480–492.60. Tosun D, Rettmann ME, Prince JL. Mapping techniques for aligning sulci across multiple brains.Medical Image Analysis 2004;8(3):295–309. [PubMed: 15450224]61. Tsitsiklis JN. Effcient algorithms for globally optimal trajectories. IEEE Trans Automat Contr Sep;1995 40(9):1528–1538.62. Tu Z, Yuille AL. Shape matching and recognition: Using generative models and informative features.Proc ECCV 2004;3:195–209.63. Van Essen DC. A population-average, landmark- and surface-based (PALS) atlas of human cerebralcortex. NeuroImage 2005;28(3):635–62. [PubMed: 16172003]64. Van Essen DC, Drury HA, Joshi S, Miller MI. Functional and structural mapping of human cerebralcortex: solutions are in the surfaces. Proc Natl Acad Sci USA 1998;95:788–795. [PubMed: 9448242]65. Wang Y, Chiang MC, Thompson PM. Automated surface matching using mutual information appliedto riemann surface structures. Proc MICCAI 2005a:666–674.66. Wang Y, Lui LM, Chan TF, Thompson PM. Optimization of brain conformal mapping withlandmarks. Proc MICCAI 2005b;2:675–683.67. Wang Y, Peterson BS, Staib LH. Shape-based 3D surface correspondence using geodesics and localgeometry. Proc CVPR 2000;2:644–651.68. Welker WI. The significance of foliation and fissuration of cerebellar cortex. the cerebellar foliumas a fundamental unit of sensorimotor integration. Arch Ital Biol 1990;128:87–109. [PubMed:2268185]69. Wells WM, Viola P, Atsumi H, Nakajima S, Kikinis R. Multimodal volume registration bymaximization of mutual information. Medical Image Analysis 1996;1:35–52. [PubMed: 9873920]Med Image Anal. Author manuscript; available in PMC 2008 June 1.   Shi et al.Page 21Fig. 1.The parametric approach of cortical mapping.I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptMed Image Anal. Author manuscript; available in PMC 2008 June 1.   Shi et al.Page 22Fig. 2. An illustration of the narrow band of a manifold ℳ in 2DThe thick curve is the manifold of interest and the gray region surrounding it is where theimplicit mapping approach solve the PDE derived from the Euler-Lagrange equation of theharmonic energy.I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptMed Image Anal. Author manuscript; available in PMC 2008 June 1.   Shi et al.Page 23Fig. 3.The extended surface of a landmark curve(the thick black line) is represented as a triangularmesh.I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptMed Image Anal. Author manuscript; available in PMC 2008 June 1.   Shi et al.Page 24Fig. 4. The input data for the mapping of two cortical surfaces(a) The source cortex. (b) The target cortex. (c) The set of sulcal landmark curves of the sourcecortex. (d) The set of sulcal landmark curves of the target cortex.I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptMed Image Anal. Author manuscript; available in PMC 2008 June 1.   Shi et al.Page 25Fig. 5.The set of extended surfaces constructed from all the landmark curves of the source corticalsurface.I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptMed Image Anal. Author manuscript; available in PMC 2008 June 1.   Shi et al.Page 26Fig. 6. Visualization of the direct map between cortical surfaces in both the lateral and medial view(a) and (b) are the checkerboard pattern on the source cortex. (c) and (d) are the checkerboardpattern mapped onto the target cortex using the initial map. (e) and (f) are the checkerboardpattern mapped onto the target cortex using the direct map computed from our algorithm. Thesmoothness of the map is improved as can be seen in regions inside the black ellipses.I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptMed Image Anal. Author manuscript; available in PMC 2008 June 1.   Shi et al.Page 27I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptFig. 7.The energy decreases over the solution process.I-NHPAAuthorManuscriptMed Image Anal. Author manuscript; available in PMC 2008 June 1.   Shi et al.Page 28Fig. 8.The direct map on seven major sulcal curves. The thin and blue lines are the sulcal curves onthe source cortex and the thick and red lines are the sulcal curves on the target cortex. The mapis visualized as the displacement vector fields on the sulcal curves of the source cortex.I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptMed Image Anal. Author manuscript; available in PMC 2008 June 1.   Shi et al.Page 29I-NHPAAuthorManuscriptFig. 9. The effect of improving angle distortions with the direct map(a) The distribution of angle distortions from the initial map (mean = 0.5726°, std = 31.8831°.(b) The distribution of angle distortions from the direct map (mean = 0.9208°, std = 26.5888°).I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptMed Image Anal. Author manuscript; available in PMC 2008 June 1.   Shi et al.Page 30I-NHPAAuthorManuscriptFig. 10. The mean curvature map on cortical surfaces(a) The source cortex. (b) The target cortex.I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptMed Image Anal. Author manuscript; available in PMC 2008 June 1.   I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptShi et al.Page 31Fig. 11. The change of the energy functions over time(a) The total energy with both the harmonic energy and the data term. (b) The harmonic energy.(c) The data term energy.Med Image Anal. Author manuscript; available in PMC 2008 June 1.   Shi et al.Page 32I-NHPAAuthorManuscriptFig. 12. Visualization of the map computed from the minimization of the energy with the leastsquare data term(a) The lateral view. (b) The medial view.I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptMed Image Anal. Author manuscript; available in PMC 2008 June 1.   I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptShi et al.Page 33Fig. 13. A comparison of the metric distortion property of the direct and parametric mappingalgorithm(a) The mean of the metric distortions on each pair. (b) The standard deviation of the metricdistortions on each pair.Med Image Anal. Author manuscript; available in PMC 2008 June 1.   Shi et al.Page 34Fig. 14.The construction of a cortical atlas from a group of nine subjects.I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptMed Image Anal. Author manuscript; available in PMC 2008 June 1.   Shi et al.Page 35I-NHPAAuthorManuscriptFig. 15. The cortical atlas(a) Lateral view. (b) Medial view.I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptMed Image Anal. Author manuscript; available in PMC 2008 June 1.   Shi et al.Page 36I-NHPAAuthorManuscriptFig. 16. The map of variability on the cortical atlas(a) Lateral view. (b) Medial View.I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptMed Image Anal. Author manuscript; available in PMC 2008 June 1.   Shi et al.Page 37The algorithm for finding the initial map using landmark contextTable 1•••••Step 1: Initialize the heaps Hℳ and HN. Initialize an array IsMatched as false at each vertex of ℳ.Step 2: pS = pop_out(Hℳ) and pT = pop_out(HN).Step 3: If IsMatched(pS)=true, go back to Step 2. Otherwise, save the match result at pS as pT. Set IsMatched(pS) = true.Step 4: For each 1-ring neighbor pi of pS that has not been matched, find its best match in the P-ring neighborhood of pT using the correlationof landmark context. Push pi into Hℳ and its map into HN.Step 5: If the heaps are empty, stop the algorithm. Otherwise, go back to Step 2.I-NHPAAuthorManuscriptI-NHPAAuthorManuscriptI-NHPAAuthorManuscriptMed Image Anal. Author manuscript; available in PMC 2008 June 1.   